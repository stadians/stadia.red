import { storage } from "./storage.js";
import * as records from "./records.js";
export const spider = async () => {
  const usage = await storage.usage();
  const schema = 20200202;
  if (0 !== (await storage.get("schema"))) {
    console.debug(`Resetting storage for schema ${schema}.`);
    await storage.clear();
    await storage.set("schema", 0);
  }
  console.debug(`Using ${usage} bytes of storage with schema ${schema}.`);
  await new Promise((resolve) => setTimeout(resolve, 10));
  try {
    const spider = new Spider();
    window["spider"] = spider;
    console.debug("starting spider", spider);
    const data = await spider.load();
    console.debug("completed spider", spider, data);
    spider.download();
    await storage.set("skus", spider.skus);
  } catch (error) {
    console.error(error);
  }
};
class Spider {
  constructor(skus = {}, spidered = {}) {
    this.skus = skus;
    this.spidered = spidered;
    let start;
    const started = new Promise((resolve) => (start = resolve));
    this.start = start;
    this.done = started
      .then(() => this.spider())
      .then(() => {
        Object.freeze(this.skus);
        for (const sku of Object.values(this.skus)) {
          Object.freeze(sku);
        }
      });
  }
  async load() {
    this.start();
    await this.done;
    return this.skus;
  }
  async spider() {
    await this.loadSkuDetails("59c8314ac82a456ba61d08988b15b550");
    await this.loadSkuDetails("b171fc78d4e1496d9536d585257a771e");
    await this.loadSkuDetails("4950959380034dcda0aecf98f675e11f");
    await this.loadSkuDetails("2e07db5d338d40cb9eac9deae4154f11");
    await this.loadSkuList(3);
    await this.loadSkuList(2001);
    await this.loadSkuList(45);
    await this.loadSkuList(6);
    console.warn(
      "TODO: re-enable spidering once we've finished the above tweaks."
    );
    return;
    while (Object.keys(this.skus).length > Object.keys(this.spidered).length) {
      for (const sku of Object.values(this.skus)) {
        if (this.spidered[sku.sku] !== true) {
          console.debug("spidering ", sortySlugy(sku), sku);
          await this.loadSkuDetails(sku.sku);
          this.spidered[sku.sku] = true;
        }
      }
    }
  }
  download() {
    const output = records.sorted(
      Object.fromEntries(
        Object.values(this.skus)
          .map((sku) => records.sorted(sku))
          .map((sku) => [sku.localKey, sku])
      )
    );
    const json = JSON.stringify(output, null, 2);
    // XXX: this blob is leaked
    const href = URL.createObjectURL(
      new Blob([json], {
        type: "application/json",
      })
    );
    const el = Object.assign(document.createElement("a"), {
      download: "skus.json",
      href,
    });
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async loadSkuList(number) {
    await this.fetchPreloadData(`store/list/${number}`);
  }
  async loadSkuDetails(sku) {
    await this.fetchPreloadData(`store/details/_/sku/${sku}`);
  }
  loadSkuData(data, pricing) {
    const typeId = data[6];
    console.log({ pricing });
    // pricing should include normal price, pro price,
    // current sale prices for each, the start and end dates of each sale
    let sku;
    if (typeId === 1) {
      sku = new Game(data[4], data[0], "game", data[1], data[5], data[9]);
    } else if (typeId === 2) {
      sku = new AddOn(data[4], data[0], "addon", data[1], data[5], data[9]);
    } else if (typeId === 3) {
      sku = new Bundle(
        data[4],
        data[0],
        "bundle",
        data[1],
        data[5],
        data[9],
        data[14][0].map((x) => x[0])
      );
    } else if (typeId === 5) {
      sku = new Subscription(
        data[4],
        data[0],
        "subscription",
        data[1],
        data[5],
        data[9],
        data[14][0].map((x) => x[0])
      );
    } else {
      throw new Error(
        `unexpected sku type id ${JSON.stringify(typeId, null, 4)}`
      );
    }
    return this.loadSku(sku);
  }
  loadSku(sku) {
    const existing = this.skus[sku.sku];
    if (existing) {
      const existingJson = JSON.stringify(existing);
      const newJson = JSON.stringify(sku);
      if (existingJson !== newJson) {
        console.warn(`skus had same ids but different properties.`);
        Object.assign(existing, sku);
      }
      return existing;
    } else {
      this.skus[sku.sku] = sku;
      return sku;
    }
  }
  async fetchPreloadData(path) {
    await new Promise((resolve) =>
      setTimeout(resolve, Math.random() * 1000 + 2000)
    );
    const response = await fetch("https://stadia.google.com/" + path);
    const html = await response.text();
    const document = new DOMParser().parseFromString(html, "text/html");
    const scripts = Array.from(document.scripts);
    const contents = scripts.map((s) => s.textContent.trim()).filter(Boolean);
    const dataServiceRequestsPattern = /^var *AF_initDataKeys[^]*?var *AF_dataServiceRequests *= *({[^]*}); *?var /;
    const dataServiceRequests = contents
      .map((s) => s.match(dataServiceRequestsPattern))
      .filter(Boolean)
      .map((matches) =>
        JSON.parse(
          matches[1]
            .replace(/{id:/g, '{"id":')
            .replace(/,request:/g, ',"request":')
            .replace(/'/g, '"')
        )
      )
      .map((requests) =>
        Object.fromEntries(
          Object.entries(requests).map(([key, value]) => [key, value])
        )
      )[0];
    const dataCallbackPattern = /^ *AF_initDataCallback *\( *{ *key *: *'ds:([0-9]+?)' *,[^]*?data: *function *\( *\){ *return *([^]*)\s*}\s*}\s*\)\s*;?\s*$/;
    const dataServiceLoads = [];
    for (const matches of contents
      .map((s) => s.match(dataCallbackPattern))
      .filter(Boolean)) {
      dataServiceLoads[matches[1]] = JSON.parse(matches[2]);
    }
    6;
    const dataServiceRpcPrefixes = Object.values(dataServiceRequests).map(
      (x) => {
        const pieces = [x.id, ...x.request];
        const aliases = [];
        aliases.push(
          `${pieces[0]}_${pieces.filter((x) => x != null).length - 1}s${
            pieces.filter(Boolean).length - 1
          }t${pieces.length - 1}a`
        );
        while (pieces.length) {
          aliases.push(pieces.join("_"));
          pieces.pop();
        }
        return aliases;
      }
    );
    const preload = Object.values(dataServiceLoads);
    const rpc = {};
    const loaded = {};
    const loaders = {
      WwD3rb: (data) => {
        const skus = data[2].map((p) => this.loadSkuData(p[9]));
        return { skus };
      },
      FWhQV_24r: (data) => {
        const gameData = data[18]?.[0]?.[9];
        const gamePricingData = data[18]?.[0]?.[15]?.[0];
        const game = gameData && this.loadSkuData(gameData, gamePricingData);
        const addons = data[19]?.map((x) => this.loadSkuData(x[9]));
        const skuData = data[16];
        const skuPricingData = data[21]?.[0];
        const sku = skuData && this.loadSkuData(skuData, skuPricingData);
        return { sku, game, addons };
      },
      SYcsTd: (data) => {
        const subscriptionDatas = data[2]?.map((x) => x[9]) ?? [];
        const subscriptions = subscriptionDatas.map((s) => this.loadSkuData(s));
        if (subscriptions?.length) return { subscriptions };
        else return {};
      },
      ZAm7W: (data) => {
        const bundles = data[1].map((x) => this.loadSkuData(x[9]));
        return { bundles };
      },
    };
    for (const [i, data] of Object.entries(preload)) {
      for (const prefix of dataServiceRpcPrefixes[i]) {
        for (const suffix of ["", "_" + Object.keys(data).length + "r"]) {
          rpc[prefix + suffix] = data;
          const loader = loaders[prefix + suffix];
          if (loader) {
            Object.assign(loaded, loader(data));
          }
        }
      }
    }
    const data = Object.assign(
      Object.create({
        preload,
        rpc,
      }),
      loaded
    );
    console.debug(path, data);
    return data;
  }
}
const sortySlugy = (sku) => {
  const length = 32;
  const maxNameLength = 23;
  const typeTag =
    { game: "g", addon: "o", bundle: "x", subscription: "c" }[sku.type] ??
    `?${sku.type}?`;
  const idsPrefix = sku.app.slice(0, 6) + sku.sku.slice(0, 2);
  const idsRest = sku.app.slice(6) + sku.sku.slice(2);
  let name = (sku.name + sku.internalSlug)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "");
  if (name.length > maxNameLength) {
    const letterCounts = {};
    for (const letter of name) {
      letterCounts[letter] = (letterCounts[letter] || 0) + 1;
    }
    while (name.length > maxNameLength) {
      const mostFrequentCount = Math.max(...Object.values(letterCounts));
      const mostFrequent = Object.entries(letterCounts)
        .filter(([_letter, count]) => count == mostFrequentCount)
        .map(([letter, _count]) => letter);
      for (let i = name.length - 1; i >= 0; i -= 1) {
        const letter = name[i];
        if (mostFrequent.includes(letter)) {
          name = name.slice(0, i) + name.slice(i + 1);
          letterCounts[letter] -= 1;
          break;
        }
      }
    }
  }
  return (typeTag + idsPrefix + name + idsRest).slice(0, length);
};
class CommonSku {
  constructor(app, sku, type, name, internalSlug, description) {
    this.app = app;
    this.sku = sku;
    this.type = type;
    this.name = name;
    this.internalSlug = internalSlug;
    this.description = description;
    this.localKey = sortySlugy(this);
  }
}
class Game extends CommonSku {
  constructor(app, sku, type = "game", name, internalSlug, description) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
  }
}
class AddOn extends CommonSku {
  constructor(app, sku, type = "addon", name, internalSlug, description) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
  }
}
class Bundle extends CommonSku {
  constructor(
    app,
    sku,
    type = "bundle",
    name,
    internalSlug,
    description,
    skus
  ) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
    this.skus = skus;
  }
}
class Subscription extends CommonSku {
  constructor(
    app,
    sku,
    type = "subscription",
    name,
    internalSlug,
    description,
    skus
  ) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
    this.skus = skus;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BpZGVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzcGlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEtBQUssT0FBTyxNQUFNLGNBQWMsQ0FBQztBQUV4QyxNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsS0FBSyxJQUFJLEVBQUU7SUFDL0IsTUFBTSxLQUFLLEdBQUcsTUFBTSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDcEMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7UUFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUN6RCxNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN0QixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQ2hDO0lBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssaUNBQWlDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFFeEUsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3hELElBQUk7UUFDRixNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQzVCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDMUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6QyxNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqQyxPQUFPLENBQUMsS0FBSyxDQUFDLGtC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SSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFOOUMsU0FBSSxHQUFKLElBQUksQ0FBb0I7UUFFeEIsaUJBQVksR0FBWixZQUFZLENBQVE7UUFDcEIsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFDbkIsU0FBSSxHQUFKLElBQUksQ0FBZTtJQUc5QixDQUFDO0NBQ0Y7QUFFRCxNQUFNLFlBQWEsU0FBUSxTQUFTO0lBQ2xDLFlBQ0UsR0FBVyxFQUNYLEdBQVcsRUFDRixPQUFPLGNBQXVCLEVBQ3ZDLElBQVksRUFDSCxZQUFvQixFQUNwQixXQUFtQixFQUNuQixJQUFtQjtRQUU1QixLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztRQU45QyxTQUFJLEdBQUosSUFBSSxDQUEwQjtRQUU5QixpQkFBWSxHQUFaLFlBQVksQ0FBUTtRQUNwQixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUNuQixTQUFJLEdBQUosSUFBSSxDQUFlO0lBRzlCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHN0b3JhZ2UgfSBmcm9tIFwiLi9zdG9yYWdlLmpzXCI7XG5pbXBvcnQgKiBhcyByZWNvcmRzIGZyb20gXCIuL3JlY29yZHMuanNcIjtcblxuZXhwb3J0IGNvbnN0IHNwaWRlciA9IGFzeW5jICgpID0+IHtcbiAgY29uc3QgdXNhZ2UgPSBhd2FpdCBzdG9yYWdlLnVzYWdlKCk7XG4gIGNvbnN0IHNjaGVtYSA9IDIwMjAwMjAyO1xuICBpZiAoMCAhPT0gKGF3YWl0IHN0b3JhZ2UuZ2V0KFwic2NoZW1hXCIpKSkge1xuICAgIGNvbnNvbGUuZGVidWcoYFJlc2V0dGluZyBzdG9yYWdlIGZvciBzY2hlbWEgJHtzY2hlbWF9LmApO1xuICAgIGF3YWl0IHN0b3JhZ2UuY2xlYXIoKTtcbiAgICBhd2FpdCBzdG9yYWdlLnNldChcInNjaGVtYVwiLCAwKTtcbiAgfVxuICBjb25zb2xlLmRlYnVnKGBVc2luZyAke3VzYWdlfSBieXRlcyBvZiBzdG9yYWdlIHdpdGggc2NoZW1hICR7c2NoZW1hfS5gKTtcblxuICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMCkpO1xuICB0cnkge1xuICAgIGNvbnN0IHNwaWRlciA9IG5ldyBTcGlkZXIoKTtcbiAgICB3aW5kb3dbXCJzcGlkZXJcIl0gPSBzcGlkZXI7XG4gICAgY29uc29sZS5kZWJ1ZyhcInN0YXJ0aW5nIHNwaWRlclwiLCBzcGlkZXIpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBzcGlkZXIubG9hZCgpO1xuICAgIGNvbnNvbGUuZGVidWcoXCJjb21wbGV0ZWQgc3BpZGVyXCIsIHNwaWRlciwgZGF0YSk7XG4gICAgc3BpZGVyLmRvd25sb2FkKCk7XG4gICAgYXdhaXQgc3RvcmFnZS5zZXQoXCJza3VzXCIsIHNwaWRlci5za3VzKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxufTtcblxudHlwZSBQcm90b0RhdGEgPSBhbnkgJiBBcnJheTxQcm90b0RhdGEgfCBudW1iZXIgfCBzdHJpbmcgfCBib29sZWFuIHwgbnVsbD47XG50eXBlIFNrdSA9IEdhbWUgfCBBZGRPbiB8IEJ1bmRsZSB8IFN1YnNjcmlwdGlvbjtcblxuY2xhc3MgU3BpZGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFydDogKCkgPT4gdm9pZDtcbiAgcHJpdmF0ZSByZWFkb25seSBkb25lOiBQcm9taXNlPHVua25vd24+O1xuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBza3VzOiBSZWNvcmQ8U2t1W1wic2t1XCJdLCBTa3U+ID0ge30sXG4gICAgcHJpdmF0ZSByZWFkb25seSBzcGlkZXJlZDogUmVjb3JkPFNrdVtcInNrdVwiXSwgdHJ1ZT4gPSB7fVxuICApIHtcbiAgICBsZXQgc3RhcnQ6ICgpID0+IHZvaWQ7XG4gICAgY29uc3Qgc3RhcnRlZCA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiAoc3RhcnQgPSByZXNvbHZlKSk7XG4gICAgdGhpcy5zdGFydCA9IHN0YXJ0O1xuICAgIHRoaXMuZG9uZSA9IHN0YXJ0ZWRcbiAgICAgIC50aGVuKCgpID0+IHRoaXMuc3BpZGVyKCkpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcy5za3VzKTtcbiAgICAgICAgZm9yIChjb25zdCBza3Ugb2YgT2JqZWN0LnZhbHVlcyh0aGlzLnNrdXMpKSB7XG4gICAgICAgICAgT2JqZWN0LmZyZWV6ZShza3UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsb2FkKCkge1xuICAgIHRoaXMuc3RhcnQoKTtcbiAgICBhd2FpdCB0aGlzLmRvbmU7XG4gICAgcmV0dXJuIHRoaXMuc2t1cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3BpZGVyKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdURldGFpbHMoXCI1OWM4MzE0YWM4MmE0NTZiYTYxZDA4OTg4YjE1YjU1MFwiKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VEZXRhaWxzKFwiYjE3MWZjNzhkNGUxNDk2ZDk1MzZkNTg1MjU3YTc3MWVcIik7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhcIjQ5NTA5NTkzODAwMzRkY2RhMGFlY2Y5OGY2NzVlMTFmXCIpO1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdURldGFpbHMoXCIyZTA3ZGI1ZDMzOGQ0MGNiOWVhYzlkZWFlNDE1NGYxMVwiKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VMaXN0KDMpO1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoMjAwMSk7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCg0NSk7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCg2KTtcblxuICAgIGNvbnNvbGUud2FybihcbiAgICAgIFwiVE9ETzogcmUtZW5hYmxlIHNwaWRlcmluZyBvbmNlIHdlJ3ZlIGZpbmlzaGVkIHRoZSBhYm92ZSB0d2Vha3MuXCJcbiAgICApO1xuICAgIHJldHVybjtcbiAgICB3aGlsZSAoT2JqZWN0LmtleXModGhpcy5za3VzKS5sZW5ndGggPiBPYmplY3Qua2V5cyh0aGlzLnNwaWRlcmVkKS5sZW5ndGgpIHtcbiAgICAgIGZvciAoY29uc3Qgc2t1IG9mIE9iamVjdC52YWx1ZXModGhpcy5za3VzKSkge1xuICAgICAgICBpZiAodGhpcy5zcGlkZXJlZFtza3Uuc2t1XSAhPT0gdHJ1ZSkge1xuICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJzcGlkZXJpbmcgXCIsIHNvcnR5U2x1Z3koc2t1KSwgc2t1KTtcbiAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRTa3VEZXRhaWxzKHNrdS5za3UpO1xuICAgICAgICAgIHRoaXMuc3BpZGVyZWRbc2t1LnNrdV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGRvd25sb2FkKCkge1xuICAgIGNvbnN0IG91dHB1dCA9IHJlY29yZHMuc29ydGVkKFxuICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICBPYmplY3QudmFsdWVzKHRoaXMuc2t1cylcbiAgICAgICAgICAubWFwKChza3UpID0+IHJlY29yZHMuc29ydGVkKHNrdSkpXG4gICAgICAgICAgLm1hcCgoc2t1KSA9PiBbc2t1LmxvY2FsS2V5LCBza3VdKVxuICAgICAgKVxuICAgICk7XG4gICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KG91dHB1dCwgbnVsbCwgMik7XG4gICAgLy8gWFhYOiB0aGlzIGJsb2IgaXMgbGVha2VkXG4gICAgY29uc3QgaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoXG4gICAgICBuZXcgQmxvYihbanNvbl0sIHtcbiAgICAgICAgdHlwZTogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICB9KVxuICAgICk7XG4gICAgY29uc3QgZWwgPSBPYmplY3QuYXNzaWduKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhXCIpLCB7XG4gICAgICBkb3dubG9hZDogXCJza3VzLmpzb25cIixcbiAgICAgIGhyZWYsXG4gICAgfSk7XG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlbCk7XG4gICAgZWwuY2xpY2soKTtcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGVsKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFNrdUxpc3QobnVtYmVyOiBudW1iZXIpIHtcbiAgICBhd2FpdCB0aGlzLmZldGNoUHJlbG9hZERhdGEoYHN0b3JlL2xpc3QvJHtudW1iZXJ9YCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRTa3VEZXRhaWxzKHNrdTogc3RyaW5nKSB7XG4gICAgYXdhaXQgdGhpcy5mZXRjaFByZWxvYWREYXRhKGBzdG9yZS9kZXRhaWxzL18vc2t1LyR7c2t1fWApO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkU2t1RGF0YShkYXRhOiBQcm90b0RhdGEsIHByaWNpbmc6IFByb3RvRGF0YSk6IFNrdSB7XG4gICAgY29uc3QgdHlwZUlkID0gZGF0YVs2XTtcblxuICAgIGNvbnNvbGUubG9nKHsgcHJpY2luZyB9KTtcbiAgICAvLyBwcmljaW5nIHNob3VsZCBpbmNsdWRlIG5vcm1hbCBwcmljZSwgcHJvIHByaWNlLFxuICAgIC8vIGN1cnJlbnQgc2FsZSBwcmljZXMgZm9yIGVhY2gsIHRoZSBzdGFydCBhbmQgZW5kIGRhdGVzIG9mIGVhY2ggc2FsZVxuXG4gICAgbGV0IHNrdTtcbiAgICBpZiAodHlwZUlkID09PSAxKSB7XG4gICAgICBza3UgPSBuZXcgR2FtZShkYXRhWzRdLCBkYXRhWzBdLCBcImdhbWVcIiwgZGF0YVsxXSwgZGF0YVs1XSwgZGF0YVs5XSk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDIpIHtcbiAgICAgIHNrdSA9IG5ldyBBZGRPbihkYXRhWzRdLCBkYXRhWzBdLCBcImFkZG9uXCIsIGRhdGFbMV0sIGRhdGFbNV0sIGRhdGFbOV0pO1xuICAgIH0gZWxzZSBpZiAodHlwZUlkID09PSAzKSB7XG4gICAgICBza3UgPSBuZXcgQnVuZGxlKFxuICAgICAgICBkYXRhWzRdLFxuICAgICAgICBkYXRhWzBdLFxuICAgICAgICBcImJ1bmRsZVwiLFxuICAgICAgICBkYXRhWzFdLFxuICAgICAgICBkYXRhWzVdLFxuICAgICAgICBkYXRhWzldLFxuICAgICAgICBkYXRhWzE0XVswXS5tYXAoKHg6IGFueSkgPT4geFswXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDUpIHtcbiAgICAgIHNrdSA9IG5ldyBTdWJzY3JpcHRpb24oXG4gICAgICAgIGRhdGFbNF0sXG4gICAgICAgIGRhdGFbMF0sXG4gICAgICAgIFwic3Vic2NyaXB0aW9uXCIsXG4gICAgICAgIGRhdGFbMV0sXG4gICAgICAgIGRhdGFbNV0sXG4gICAgICAgIGRhdGFbOV0sXG4gICAgICAgIGRhdGFbMTRdWzBdLm1hcCgoeDogYW55KSA9PiB4WzBdKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgdW5leHBlY3RlZCBza3UgdHlwZSBpZCAke0pTT04uc3RyaW5naWZ5KHR5cGVJZCwgbnVsbCwgNCl9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5sb2FkU2t1KHNrdSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRTa3Uoc2t1OiBTa3UpOiBTa3Uge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5za3VzW3NrdS5za3VdO1xuICAgIGlmIChleGlzdGluZykge1xuICAgICAgY29uc3QgZXhpc3RpbmdKc29uID0gSlNPTi5zdHJpbmdpZnkoZXhpc3RpbmcpO1xuICAgICAgY29uc3QgbmV3SnNvbiA9IEpTT04uc3RyaW5naWZ5KHNrdSk7XG4gICAgICBpZiAoZXhpc3RpbmdKc29uICE9PSBuZXdKc29uKSB7XG4gICAgICAgIGNvbnNvbGUud2Fybihgc2t1cyBoYWQgc2FtZSBpZHMgYnV0IGRpZmZlcmVudCBwcm9wZXJ0aWVzLmApO1xuICAgICAgICBPYmplY3QuYXNzaWduKGV4aXN0aW5nLCBza3UpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNrdXNbc2t1LnNrdV0gPSBza3U7XG4gICAgICByZXR1cm4gc2t1O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZldGNoUHJlbG9hZERhdGEocGF0aDogc3RyaW5nKSB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+XG4gICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIE1hdGgucmFuZG9tKCkgKiAxXzAwMCArIDJfMDAwKVxuICAgICk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcImh0dHBzOi8vc3RhZGlhLmdvb2dsZS5jb20vXCIgKyBwYXRoKTtcbiAgICBjb25zdCBodG1sID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgIGNvbnN0IGRvY3VtZW50ID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhodG1sLCBcInRleHQvaHRtbFwiKTtcbiAgICBjb25zdCBzY3JpcHRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5zY3JpcHRzKTtcbiAgICBjb25zdCBjb250ZW50cyA9IHNjcmlwdHMubWFwKChzKSA9PiBzLnRleHRDb250ZW50LnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pO1xuXG4gICAgY29uc3QgZGF0YVNlcnZpY2VSZXF1ZXN0c1BhdHRlcm4gPSAvXnZhciAqQUZfaW5pdERhdGFLZXlzW15dKj92YXIgKkFGX2RhdGFTZXJ2aWNlUmVxdWVzdHMgKj0gKih7W15dKn0pOyAqP3ZhciAvO1xuXG4gICAgY29uc3QgZGF0YVNlcnZpY2VSZXF1ZXN0cyA9IGNvbnRlbnRzXG4gICAgICAubWFwKChzKSA9PiBzLm1hdGNoKGRhdGFTZXJ2aWNlUmVxdWVzdHNQYXR0ZXJuKSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgIC5tYXAoKG1hdGNoZXMpID0+XG4gICAgICAgIEpTT04ucGFyc2UoXG4gICAgICAgICAgbWF0Y2hlc1sxXVxuICAgICAgICAgICAgLnJlcGxhY2UoL3tpZDovZywgJ3tcImlkXCI6JylcbiAgICAgICAgICAgIC5yZXBsYWNlKC8scmVxdWVzdDovZywgJyxcInJlcXVlc3RcIjonKVxuICAgICAgICAgICAgLnJlcGxhY2UoLycvZywgJ1wiJylcbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgLm1hcCgocmVxdWVzdHMpID0+XG4gICAgICAgIE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhyZXF1ZXN0cykubWFwKChba2V5LCB2YWx1ZV06IGFueSkgPT4gW2tleSwgdmFsdWVdKVxuICAgICAgICApXG4gICAgICApWzBdO1xuXG4gICAgY29uc3QgZGF0YUNhbGxiYWNrUGF0dGVybiA9IC9eICpBRl9pbml0RGF0YUNhbGxiYWNrICpcXCggKnsgKmtleSAqOiAqJ2RzOihbMC05XSs/KScgKixbXl0qP2RhdGE6ICpmdW5jdGlvbiAqXFwoICpcXCl7ICpyZXR1cm4gKihbXl0qKVxccyp9XFxzKn1cXHMqXFwpXFxzKjs/XFxzKiQvO1xuICAgIGNvbnN0IGRhdGFTZXJ2aWNlTG9hZHM6IEFycmF5PGFueT4gPSBbXTtcbiAgICBmb3IgKGNvbnN0IG1hdGNoZXMgb2YgY29udGVudHNcbiAgICAgIC5tYXAoKHMpID0+IHMubWF0Y2goZGF0YUNhbGxiYWNrUGF0dGVybikpXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pKSB7XG4gICAgICBkYXRhU2VydmljZUxvYWRzW21hdGNoZXNbMV1dID0gSlNPTi5wYXJzZShtYXRjaGVzWzJdKTtcbiAgICB9XG4gICAgNjtcbiAgICBjb25zdCBkYXRhU2VydmljZVJwY1ByZWZpeGVzID0gT2JqZWN0LnZhbHVlcyhkYXRhU2VydmljZVJlcXVlc3RzKS5tYXAoXG4gICAgICAoeDogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IHBpZWNlcyA9IFt4LmlkLCAuLi54LnJlcXVlc3RdO1xuICAgICAgICBjb25zdCBhbGlhc2VzID0gW107XG4gICAgICAgIGFsaWFzZXMucHVzaChcbiAgICAgICAgICBgJHtwaWVjZXNbMF19XyR7cGllY2VzLmZpbHRlcigoeDogYW55KSA9PiB4ICE9IG51bGwpLmxlbmd0aCAtIDF9cyR7XG4gICAgICAgICAgICBwaWVjZXMuZmlsdGVyKEJvb2xlYW4pLmxlbmd0aCAtIDFcbiAgICAgICAgICB9dCR7cGllY2VzLmxlbmd0aCAtIDF9YWBcbiAgICAgICAgKTtcbiAgICAgICAgd2hpbGUgKHBpZWNlcy5sZW5ndGgpIHtcbiAgICAgICAgICBhbGlhc2VzLnB1c2gocGllY2VzLmpvaW4oXCJfXCIpKTtcbiAgICAgICAgICBwaWVjZXMucG9wKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFsaWFzZXM7XG4gICAgICB9XG4gICAgKTtcblxuICAgIGNvbnN0IHByZWxvYWQgPSBPYmplY3QudmFsdWVzKGRhdGFTZXJ2aWNlTG9hZHMpO1xuICAgIGNvbnN0IHJwYzogYW55ID0ge307XG4gICAgY29uc3QgbG9hZGVkID0ge307XG5cbiAgICBjb25zdCBsb2FkZXJzOiBhbnkgPSB7XG4gICAgICBXd0QzcmI6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3Qgc2t1cyA9IGRhdGFbMl0ubWFwKChwOiBhbnkpID0+IHRoaXMubG9hZFNrdURhdGEocFs5XSkpO1xuICAgICAgICByZXR1cm4geyBza3VzIH07XG4gICAgICB9LFxuXG4gICAgICBGV2hRVl8yNHI6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3QgZ2FtZURhdGEgPSBkYXRhWzE4XT8uWzBdPy5bOV07XG4gICAgICAgIGNvbnN0IGdhbWVQcmljaW5nRGF0YSA9IGRhdGFbMThdPy5bMF0/LlsxNV0/LlswXTtcbiAgICAgICAgY29uc3QgZ2FtZSA9IGdhbWVEYXRhICYmIHRoaXMubG9hZFNrdURhdGEoZ2FtZURhdGEsIGdhbWVQcmljaW5nRGF0YSk7XG5cbiAgICAgICAgY29uc3QgYWRkb25zID0gKGRhdGFbMTldIGFzIGFueSk/Lm1hcCgoeDogYW55KSA9PlxuICAgICAgICAgIHRoaXMubG9hZFNrdURhdGEoeFs5XSlcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBza3VEYXRhID0gZGF0YVsxNl07XG4gICAgICAgIGNvbnN0IHNrdVByaWNpbmdEYXRhID0gZGF0YVsyMV0/LlswXTtcbiAgICAgICAgY29uc3Qgc2t1ID0gc2t1RGF0YSAmJiB0aGlzLmxvYWRTa3VEYXRhKHNrdURhdGEsIHNrdVByaWNpbmdEYXRhKTtcblxuICAgICAgICByZXR1cm4geyBza3UsIGdhbWUsIGFkZG9ucyB9O1xuICAgICAgfSxcblxuICAgICAgU1ljc1RkOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbkRhdGFzID0gZGF0YVsyXT8ubWFwKCh4OiBhbnkpID0+IHhbOV0pID8/IFtdO1xuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25zID0gc3Vic2NyaXB0aW9uRGF0YXMubWFwKChzKSA9PiB0aGlzLmxvYWRTa3VEYXRhKHMpKTtcbiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbnM/Lmxlbmd0aCkgcmV0dXJuIHsgc3Vic2NyaXB0aW9ucyB9O1xuICAgICAgICBlbHNlIHJldHVybiB7fTtcbiAgICAgIH0sXG5cbiAgICAgIFpBbTdXOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IGJ1bmRsZXMgPSBkYXRhWzFdLm1hcCgoeDogYW55KSA9PiB0aGlzLmxvYWRTa3VEYXRhKHhbOV0pKTtcbiAgICAgICAgcmV0dXJuIHsgYnVuZGxlcyB9O1xuICAgICAgfSxcbiAgICB9O1xuXG4gICAgZm9yIChjb25zdCBbaSwgZGF0YV0gb2YgT2JqZWN0LmVudHJpZXMocHJlbG9hZCkpIHtcbiAgICAgIGZvciAoY29uc3QgcHJlZml4IG9mIGRhdGFTZXJ2aWNlUnBjUHJlZml4ZXNbaV0pIHtcbiAgICAgICAgZm9yIChjb25zdCBzdWZmaXggb2YgW1wiXCIsIFwiX1wiICsgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoICsgXCJyXCJdKSB7XG4gICAgICAgICAgcnBjW3ByZWZpeCArIHN1ZmZpeF0gPSBkYXRhO1xuICAgICAgICAgIGNvbnN0IGxvYWRlciA9IGxvYWRlcnNbcHJlZml4ICsgc3VmZml4XTtcbiAgICAgICAgICBpZiAobG9hZGVyKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGxvYWRlZCwgbG9hZGVyKGRhdGEpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIE9iamVjdC5jcmVhdGUoe1xuICAgICAgICBwcmVsb2FkLFxuICAgICAgICBycGMsXG4gICAgICB9KSxcbiAgICAgIGxvYWRlZFxuICAgICk7XG5cbiAgICBjb25zb2xlLmRlYnVnKHBhdGgsIGRhdGEpO1xuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbn1cblxuY29uc3Qgc29ydHlTbHVneSA9IChza3U6IFNrdSB8IENvbW1vblNrdSkgPT4ge1xuICBjb25zdCBsZW5ndGggPSAzMjtcbiAgY29uc3QgbWF4TmFtZUxlbmd0aCA9IDIzO1xuICBjb25zdCB0eXBlVGFnID1cbiAgICAoeyBnYW1lOiBcImdcIiwgYWRkb246IFwib1wiLCBidW5kbGU6IFwieFwiLCBzdWJzY3JpcHRpb246IFwiY1wiIH0gYXMgYW55KVtcbiAgICAgIHNrdS50eXBlXG4gICAgXSA/PyBgPyR7c2t1LnR5cGV9P2A7XG4gIGNvbnN0IGlkc1ByZWZpeCA9IHNrdS5hcHAuc2xpY2UoMCwgNikgKyBza3Uuc2t1LnNsaWNlKDAsIDIpO1xuICBjb25zdCBpZHNSZXN0ID0gc2t1LmFwcC5zbGljZSg2KSArIHNrdS5za3Uuc2xpY2UoMik7XG5cbiAgbGV0IG5hbWUgPSAoc2t1Lm5hbWUgKyBza3UuaW50ZXJuYWxTbHVnKVxuICAgIC50b0xvd2VyQ2FzZSgpXG4gICAgLnJlcGxhY2UoL1teYS16MC05XSsvZywgXCJcIik7XG5cbiAgaWYgKG5hbWUubGVuZ3RoID4gbWF4TmFtZUxlbmd0aCkge1xuICAgIGNvbnN0IGxldHRlckNvdW50czogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuICAgIGZvciAoY29uc3QgbGV0dGVyIG9mIG5hbWUpIHtcbiAgICAgIGxldHRlckNvdW50c1tsZXR0ZXJdID0gKGxldHRlckNvdW50c1tsZXR0ZXJdIHx8IDApICsgMTtcbiAgICB9XG4gICAgd2hpbGUgKG5hbWUubGVuZ3RoID4gbWF4TmFtZUxlbmd0aCkge1xuICAgICAgY29uc3QgbW9zdEZyZXF1ZW50Q291bnQgPSBNYXRoLm1heCguLi5PYmplY3QudmFsdWVzKGxldHRlckNvdW50cykpO1xuICAgICAgY29uc3QgbW9zdEZyZXF1ZW50ID0gT2JqZWN0LmVudHJpZXMobGV0dGVyQ291bnRzKVxuICAgICAgICAuZmlsdGVyKChbX2xldHRlciwgY291bnRdKSA9PiBjb3VudCA9PSBtb3N0RnJlcXVlbnRDb3VudClcbiAgICAgICAgLm1hcCgoW2xldHRlciwgX2NvdW50XSkgPT4gbGV0dGVyKTtcbiAgICAgIGZvciAobGV0IGkgPSBuYW1lLmxlbmd0aCAtIDE7IGkgPj0gMDsgaSAtPSAxKSB7XG4gICAgICAgIGNvbnN0IGxldHRlciA9IG5hbWVbaV07XG4gICAgICAgIGlmIChtb3N0RnJlcXVlbnQuaW5jbHVkZXMobGV0dGVyKSkge1xuICAgICAgICAgIG5hbWUgPSBuYW1lLnNsaWNlKDAsIGkpICsgbmFtZS5zbGljZShpICsgMSk7XG4gICAgICAgICAgbGV0dGVyQ291bnRzW2xldHRlcl0gLT0gMTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiAodHlwZVRhZyArIGlkc1ByZWZpeCArIG5hbWUgKyBpZHNSZXN0KS5zbGljZSgwLCBsZW5ndGgpO1xufTtcblxuY2xhc3MgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgYXBwOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZTogXCJnYW1lXCIgfCBcImFkZG9uXCIgfCBcImJ1bmRsZVwiIHwgXCJzdWJzY3JpcHRpb25cIixcbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgaW50ZXJuYWxTbHVnOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgZGVzY3JpcHRpb246IHN0cmluZ1xuICApIHtcbiAgICB0aGlzLmxvY2FsS2V5ID0gc29ydHlTbHVneSh0aGlzKTtcbiAgfVxuICByZWFkb25seSBsb2NhbEtleTogc3RyaW5nO1xufVxuXG5jbGFzcyBHYW1lIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiZ2FtZVwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nXG4gICkge1xuICAgIHN1cGVyKGFwcCwgc2t1LCB0eXBlLCBuYW1lLCBpbnRlcm5hbFNsdWcsIGRlc2NyaXB0aW9uKTtcbiAgfVxufVxuXG5jbGFzcyBBZGRPbiBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcImFkZG9uXCIgYXMgY29uc3QsXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGludGVybmFsU2x1Zzogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGRlc2NyaXB0aW9uOiBzdHJpbmdcbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUsIGludGVybmFsU2x1ZywgZGVzY3JpcHRpb24pO1xuICB9XG59XG5cbmNsYXNzIEJ1bmRsZSBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcImJ1bmRsZVwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNrdXM6IEFycmF5PHN0cmluZz5cbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUsIGludGVybmFsU2x1ZywgZGVzY3JpcHRpb24pO1xuICB9XG59XG5cbmNsYXNzIFN1YnNjcmlwdGlvbiBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcInN1YnNjcmlwdGlvblwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNrdXM6IEFycmF5PHN0cmluZz5cbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUsIGludGVybmFsU2x1ZywgZGVzY3JpcHRpb24pO1xuICB9XG59XG4iXX0=
