export const spider = async () => {
  await new Promise((resolve) => setTimeout(resolve, 10));
  try {
    const spider = new Spider();
    window["spider"] = spider;
    console.debug("starting spider", spider);
    const data = await spider.load();
    console.debug("completed spider", spider, data);
    spider.download();
  } catch (error) {
    console.error(error);
  }
};
class Spider {
  constructor(skus = {}, spidered = {}) {
    this.skus = skus;
    this.spidered = spidered;
    let start;
    const started = new Promise((resolve) => (start = resolve));
    this.start = start;
    this.done = started
      .then(() => this.spider())
      .then(() => {
        Object.freeze(this.skus);
        for (const sku of Object.values(this.skus)) {
          Object.freeze(sku);
        }
      });
  }
  async load() {
    this.start();
    await this.done;
    return this.skus;
  }
  async spider() {
    await this.loadSkuList(3);
    await this.loadSkuList(2001);
    await this.loadSkuList(45);
    await this.loadSkuDetails("be9526126d394061b0eef9b16352357e");
    while (Object.keys(this.skus).length > Object.keys(this.spidered).length) {
      for (const sku of Object.values(this.skus)) {
        if (this.spidered[sku.sku] !== true) {
          console.debug("spidering ", sku.key(), sku);
          await this.loadSkuDetails(sku.sku);
          this.spidered[sku.sku] = true;
        }
      }
    }
  }
  download() {
    const json = JSON.stringify(
      Object.fromEntries(
        Object.values(this.skus).map((sku) => [sku.key(), sku])
      ),
      null,
      2
    );
    // XXX: this blob is leaked
    const href = URL.createObjectURL(
      new Blob([json], {
        type: "application/json",
      })
    );
    const el = Object.assign(document.createElement("a"), {
      download: "skus.json",
      href,
    });
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async loadSkuList(number) {
    await this.fetchPreloadData(`store/list/${number}`);
  }
  async loadSkuDetails(sku) {
    await this.fetchPreloadData(`store/details/_/sku/${sku}`);
  }
  loadSkuData(data, pricing) {
    const typeId = data[6];
    console.log({ pricing });
    // pricing should include normal price, pro price,
    // current sale prices for each, the start and end dates of each sale
    let sku;
    if (typeId === 1) {
      sku = new Game(data[4], data[0], "game", data[1]);
    } else if (typeId === 2) {
      sku = new AddOn(data[4], data[0], "addon", data[1]);
    } else if (typeId === 3) {
      sku = new Bundle(
        data[4],
        data[0],
        "bundle",
        data[1],
        data[14][0].map((x) => x[0])
      );
    } else if (typeId === 5) {
      sku = new Subscription(
        data[4],
        data[0],
        "subscription",
        data[1],
        data[14][0].map((x) => x[0])
      );
    } else {
      throw new Error(
        `unexpected sku type id ${JSON.stringify(typeId, null, 4)}`
      );
    }
    return this.loadSku(sku);
  }
  loadSku(sku) {
    const existing = this.skus[sku.sku];
    if (existing) {
      const existingJson = JSON.stringify(existing);
      const newJson = JSON.stringify(sku);
      if (existingJson !== newJson) {
        console.warn(`skus had same ids but different properties.`);
        Object.assign(existing, sku);
      }
      return existing;
    } else {
      this.skus[sku.sku] = sku;
      return sku;
    }
  }
  async fetchPreloadData(path) {
    await new Promise((resolve) =>
      setTimeout(resolve, Math.random() * 3000 + 2000)
    );
    const response = await fetch("https://stadia.google.com/" + path);
    const html = await response.text();
    const document = new DOMParser().parseFromString(html, "text/html");
    const scripts = Array.from(document.scripts);
    const contents = scripts.map((s) => s.textContent.trim()).filter(Boolean);
    const dataServiceRequestsPattern = /^var *AF_initDataKeys[^]*?var *AF_dataServiceRequests *= *({[^]*}); *?var /;
    const dataServiceRequests = contents
      .map((s) => s.match(dataServiceRequestsPattern))
      .filter(Boolean)
      .map((matches) =>
        JSON.parse(
          matches[1]
            .replace(/{id:/g, '{"id":')
            .replace(/,request:/g, ',"request":')
            .replace(/'/g, '"')
        )
      )
      .map((requests) =>
        Object.fromEntries(
          Object.entries(requests).map(([key, value]) => [key, value])
        )
      )[0];
    const dataCallbackPattern = /^ *AF_initDataCallback *\( *{ *key *: *'ds:([0-9]+?)' *,[^]*?data: *function *\( *\){ *return *([^]*)\s*}\s*}\s*\)\s*;?\s*$/;
    const dataServiceLoads = [];
    for (const matches of contents
      .map((s) => s.match(dataCallbackPattern))
      .filter(Boolean)) {
      dataServiceLoads[matches[1]] = JSON.parse(matches[2]);
    }
    const dataServiceRpcPrefixes = Object.values(dataServiceRequests).map(
      (x) => {
        const pieces = [x.id, ...x.request];
        const aliases = [];
        aliases.push(
          `${pieces[0]}_${pieces.filter((x) => x != null).length - 1}s${
            pieces.filter(Boolean).length - 1
          }t${pieces.length - 1}a`
        );
        while (pieces.length) {
          aliases.push(pieces.join("_"));
          pieces.pop();
        }
        return aliases;
      }
    );
    const preload = Object.values(dataServiceLoads);
    const rpc = {};
    const loaded = {};
    const loaders = {
      WwD3rb: (data) => {
        const skus = data[2].map((p) => this.loadSkuData(p[9]));
        return { skus };
      },
      FWhQV_24r: (data) => {
        const gameData = data[18]?.[0]?.[9];
        const gamePricingData = data[18]?.[0]?.[15]?.[0];
        const game = gameData && this.loadSkuData(gameData, gamePricingData);
        const addons = data[19]?.map((x) => this.loadSkuData(x[9]));
        const skuData = data[16];
        const skuPricingData = data[21]?.[0];
        const sku = skuData && this.loadSkuData(skuData, skuPricingData);
        return { sku, game, addons };
      },
      SYcsTd: (data) => {
        const subscriptionDatas = data[2]?.map((x) => x[9]) ?? [];
        const subscriptions = subscriptionDatas.map((s) => this.loadSkuData(s));
        if (subscriptions?.length) return { subscriptions };
        else return {};
      },
      ZAm7W: (data) => {
        const bundles = data[1].map((x) => this.loadSkuData(x[9]));
        return { bundles };
      },
    };
    for (const [i, data] of Object.entries(preload)) {
      for (const prefix of dataServiceRpcPrefixes[i]) {
        for (const suffix of ["", "_" + Object.keys(data).length + "r"]) {
          rpc[prefix + suffix] = data;
          const loader = loaders[prefix + suffix];
          if (loader) {
            Object.assign(loaded, loader(data));
          }
        }
      }
    }
    const data = Object.assign(
      Object.create({
        preload,
        rpc,
      }),
      loaded
    );
    console.debug(path, data);
    return data;
  }
}
class CommonSku {
  constructor(app, sku, type, name) {
    this.app = app;
    this.sku = sku;
    this.type = type;
    this.name = name;
  }
  key() {
    return `${
      { game: "g", addon: "o", bundle: "x", subscription: "a" }[this.type] ??
      this.type
    }${this.app.slice(0, 6)}${this.sku.slice(0, 4)}${this.name.slice(
      Math.max(0, 0 | ((this.name.length - 20) / 2)),
      20
    )}${this.sku.slice(4)}`
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "")
      .slice(0, 32);
  }
}
class Game extends CommonSku {
  constructor(app, sku, type = "game", name) {
    super(app, sku, type, name);
    this.type = type;
  }
}
class AddOn extends CommonSku {
  constructor(app, sku, type = "addon", name) {
    super(app, sku, type, name);
    this.type = type;
  }
}
class Bundle extends CommonSku {
  constructor(app, sku, type = "bundle", name, skus) {
    super(app, sku, type, name);
    this.type = type;
    this.skus = skus;
  }
}
class Subscription extends CommonSku {
  constructor(app, sku, type = "subscription", name, skus) {
    super(app, sku, type, name);
    this.type = type;
    this.skus = skus;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BpZGVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzcGlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHLEtBQUssSUFBSSxFQUFFO0lBQy9CLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4RCxJQUFJO1FBQ0YsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUM1QixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQzFCLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDekMsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEQsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQ25CO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3RCO0FBQ0gsQ0FBQyxDQUFDO0FBS0YsTUFBTSxNQUFNO0lBR1YsWUFDbUIsT0FBZ0MsRUFBRSxFQUNsQyxXQUFxQyxFQUFFO1FBRHZDLFNBQUksR0FBSixJQUFJLENBQThCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQStCO1FBRXhELElBQUksS0FBaUIsQ0FBQztRQUN0QixNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLE9BQU87YUFDaEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUN6QixJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsS0FBSyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDMUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNwQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJO1FBQ2YsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0lBRU8sS0FBSyxDQUFDLE1BQU07UUFDbEIsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFCLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDM0IsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7UUFFOUQsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxFQUFFO1lBQ3hFLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxFQUFFO29CQUNuQyxPQUFPLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQzVDLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztpQkFDL0I7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUVNLFFBQVE7UUFDYixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUN6QixNQUFNLENBQUMsV0FBVyxDQUNoQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQ3hELEVBQ0QsSUFBSSxFQUNKLENBQUMsQ0FDRixDQUFDO1FBQ0YsMkJBQTJCO1FBQzNCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxlQUFlLENBQzlCLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDZixJQUFJLEVBQUUsa0JBQWtCO1NBQ3pCLENBQUMsQ0FDSCxDQUFDO1FBQ0YsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3BELFFBQVEsRUFBRSxXQUFXO1lBQ3JCLElBQUk7U0FDTCxDQUFDLENBQUM7UUFDSCxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5QixFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDWCxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFjO1FBQ3RDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxHQUFXO1FBQ3RDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFTyxXQUFXLENBQUMsSUFBZSxFQUFFLE9BQWtCO1FBQ3JELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV2QixPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUN6QixrREFBa0Q7UUFDbEQscUVBQXFFO1FBRXJFLElBQUksR0FBRyxDQUFDO1FBQ1IsSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ2hCLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuRDthQUFNLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN2QixHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDckQ7YUFBTSxJQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDdkIsR0FBRyxHQUFHLElBQUksTUFBTSxDQUNkLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDUCxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQ1AsUUFBUSxFQUNSLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDUCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDN0IsQ0FBQztTQUNIO2FBQU0sSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3ZCLEdBQUcsR0FBRyxJQUFJLFlBQVksQ0FDcEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNQLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDUCxjQUFjLEVBQ2QsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNQLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUM3QixDQUFDO1NBQ0g7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQ2IsMEJBQTBCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxDQUM1RCxDQUFDO1NBQ0g7UUFFRCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVPLE9BQU8sQ0FBQyxHQUFRO1FBQ3RCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLElBQUksUUFBUSxFQUFFO1lBQ1osTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BDLElBQUksWUFBWSxLQUFLLE9BQU8sRUFBRTtnQkFDNUIsT0FBTyxDQUFDLElBQUksQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO2dCQUM1RCxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUM5QjtZQUNELE9BQU8sUUFBUSxDQUFDO1NBQ2pCO2FBQU07WUFDTCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7WUFDekIsT0FBTyxHQUFHLENBQUM7U0FDWjtJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBWTtRQUNqQyxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FDNUIsVUFBVSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsSUFBSyxHQUFHLElBQUssQ0FBQyxDQUNuRCxDQUFDO1FBQ0YsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsNEJBQTRCLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDbEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkMsTUFBTSxRQUFRLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFMUUsTUFBTSwwQkFBMEIsR0FBRyw0RUFBNEUsQ0FBQztRQUVoSCxNQUFNLG1CQUFtQixHQUFHLFFBQVE7YUFDakMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7YUFDL0MsTUFBTSxDQUFDLE9BQU8sQ0FBQzthQUNmLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQ2YsSUFBSSxDQUFDLEtBQUssQ0FDUixPQUFPLENBQUMsQ0FBQyxDQUFDO2FBQ1AsT0FBTyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7YUFDMUIsT0FBTyxDQUFDLFlBQVksRUFBRSxhQUFhLENBQUM7YUFDcEMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FDdEIsQ0FDRjthQUNBLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQ2hCLE1BQU0sQ0FBQyxXQUFXLENBQ2hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQ2xFLENBQ0YsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVQLE1BQU0sbUJBQW1CLEdBQUcsNkhBQTZILENBQUM7UUFDMUosTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDNUIsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRO2FBQzNCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO2FBQ3hDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNsQixnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3ZEO1FBRUQsTUFBTSxzQkFBc0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUMsR0FBRyxDQUNuRSxDQUFDLENBQU0sRUFBRSxFQUFFO1lBQ1QsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNuQixPQUFPLENBQUMsSUFBSSxDQUNWLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUN4RCxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUNsQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQ3pCLENBQUM7WUFDRixPQUFPLE1BQU0sQ0FBQyxNQUFNLEVBQUU7Z0JBQ3BCLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7YUFDZDtZQUNELE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUMsQ0FDRixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNmLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVsQixNQUFNLE9BQU8sR0FBRztZQUNkLE1BQU0sRUFBRSxDQUFDLElBQWUsRUFBRSxFQUFFO2dCQUMxQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdELE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztZQUNsQixDQUFDO1lBRUQsU0FBUyxFQUFFLENBQUMsSUFBZSxFQUFFLEVBQUU7Z0JBQzdCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakQsTUFBTSxJQUFJLEdBQUcsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxDQUFDO2dCQUVyRSxNQUFNLE1BQU0sR0FBSSxJQUFJLENBQUMsRUFBRSxDQUFTLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FDL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDdkIsQ0FBQztnQkFFRixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3pCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBRWpFLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDO1lBQy9CLENBQUM7WUFFRCxNQUFNLEVBQUUsQ0FBQyxJQUFlLEVBQUUsRUFBRTtnQkFDMUIsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzFELE1BQU0sYUFBYSxHQUFHLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4RSxJQUFJLGFBQWEsRUFBRSxNQUFNO29CQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsQ0FBQzs7b0JBQy9DLE9BQU8sRUFBRSxDQUFDO1lBQ2pCLENBQUM7WUFFRCxLQUFLLEVBQUUsQ0FBQyxJQUFlLEVBQUUsRUFBRTtnQkFDekIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMzRCxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUM7WUFDckIsQ0FBQztTQUNGLENBQUM7UUFFRixLQUFLLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUMvQyxLQUFLLE1BQU0sTUFBTSxJQUFJLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUM5QyxLQUFLLE1BQU0sTUFBTSxJQUFJLENBQUMsRUFBRSxFQUFFLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsRUFBRTtvQkFDL0QsR0FBRyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7b0JBQzVCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLENBQUM7b0JBQ3hDLElBQUksTUFBTSxFQUFFO3dCQUNWLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO3FCQUNyQztpQkFDRjthQUNGO1NBQ0Y7UUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUN4QixNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ1osT0FBTztZQUNQLEdBQUc7U0FDSixDQUFDLEVBQ0YsTUFBTSxDQUNQLENBQUM7UUFFRixPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUUxQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRjtBQUVELE1BQU0sU0FBUztJQUNiLFlBQ1csR0FBVyxFQUNYLEdBQVcsRUFDWCxJQUFrRCxFQUNsRCxJQUFZO1FBSFosUUFBRyxHQUFILEdBQUcsQ0FBUTtRQUNYLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDWCxTQUFJLEdBQUosSUFBSSxDQUE4QztRQUNsRCxTQUFJLEdBQUosSUFBSSxDQUFRO0lBQ3BCLENBQUM7SUFFRyxHQUFHO1FBQ1IsT0FBTyxHQUNMLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDcEUsSUFBSSxDQUFDLElBQ1AsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUM5RCxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQzlDLEVBQUUsQ0FDSCxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO2FBQ3BCLFdBQVcsRUFBRTthQUNiLE9BQU8sQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDO2FBQzFCLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEIsQ0FBQztDQUNGO0FBRUQsTUFBTSxJQUFLLFNBQVEsU0FBUztJQUMxQixZQUNFLEdBQVcsRUFDWCxHQUFXLEVBQ0YsT0FBTyxNQUFlLEVBQy9CLElBQVk7UUFFWixLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFIbkIsU0FBSSxHQUFKLElBQUksQ0FBa0I7SUFJakMsQ0FBQztDQUNGO0FBRUQsTUFBTSxLQUFNLFNBQVEsU0FBUztJQUMzQixZQUNFLEdBQVcsRUFDWCxHQUFXLEVBQ0YsT0FBTyxPQUFnQixFQUNoQyxJQUFZO1FBRVosS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSG5CLFNBQUksR0FBSixJQUFJLENBQW1CO0lBSWxDLENBQUM7Q0FDRjtBQUVELE1BQU0sTUFBTyxTQUFRLFNBQVM7SUFDNUIsWUFDRSxHQUFXLEVBQ1gsR0FBVyxFQUNGLE9BQU8sUUFBaUIsRUFDakMsSUFBWSxFQUNILElBQW1CO1FBRTVCLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUpuQixTQUFJLEdBQUosSUFBSSxDQUFvQjtRQUV4QixTQUFJLEdBQUosSUFBSSxDQUFlO0lBRzlCLENBQUM7Q0FDRjtBQUVELE1BQU0sWUFBYSxTQUFRLFNBQVM7SUFDbEMsWUFDRSxHQUFXLEVBQ1gsR0FBVyxFQUNGLE9BQU8sY0FBdUIsRUFDdkMsSUFBWSxFQUNILElBQW1CO1FBRTVCLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUpuQixTQUFJLEdBQUosSUFBSSxDQUEwQjtRQUU5QixTQUFJLEdBQUosSUFBSSxDQUFlO0lBRzlCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBjb25zdCBzcGlkZXIgPSBhc3luYyAoKSA9PiB7XG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwKSk7XG4gIHRyeSB7XG4gICAgY29uc3Qgc3BpZGVyID0gbmV3IFNwaWRlcigpO1xuICAgIHdpbmRvd1tcInNwaWRlclwiXSA9IHNwaWRlcjtcbiAgICBjb25zb2xlLmRlYnVnKFwic3RhcnRpbmcgc3BpZGVyXCIsIHNwaWRlcik7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHNwaWRlci5sb2FkKCk7XG4gICAgY29uc29sZS5kZWJ1ZyhcImNvbXBsZXRlZCBzcGlkZXJcIiwgc3BpZGVyLCBkYXRhKTtcbiAgICBzcGlkZXIuZG93bmxvYWQoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgfVxufTtcblxudHlwZSBQcm90b0RhdGEgPSBhbnkgJiBBcnJheTxQcm90b0RhdGEgfCBudW1iZXIgfCBzdHJpbmcgfCBib29sZWFuIHwgbnVsbD47XG50eXBlIFNrdSA9IEdhbWUgfCBBZGRPbiB8IEJ1bmRsZSB8IFN1YnNjcmlwdGlvbjtcblxuY2xhc3MgU3BpZGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFydDogKCkgPT4gdm9pZDtcbiAgcHJpdmF0ZSByZWFkb25seSBkb25lOiBQcm9taXNlPHVua25vd24+O1xuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBza3VzOiBSZWNvcmQ8U2t1W1wic2t1XCJdLCBTa3U+ID0ge30sXG4gICAgcHJpdmF0ZSByZWFkb25seSBzcGlkZXJlZDogUmVjb3JkPFNrdVtcInNrdVwiXSwgdHJ1ZT4gPSB7fVxuICApIHtcbiAgICBsZXQgc3RhcnQ6ICgpID0+IHZvaWQ7XG4gICAgY29uc3Qgc3RhcnRlZCA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiAoc3RhcnQgPSByZXNvbHZlKSk7XG4gICAgdGhpcy5zdGFydCA9IHN0YXJ0O1xuICAgIHRoaXMuZG9uZSA9IHN0YXJ0ZWRcbiAgICAgIC50aGVuKCgpID0+IHRoaXMuc3BpZGVyKCkpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIE9iamVjdC5mcmVlemUodGhpcy5za3VzKTtcbiAgICAgICAgZm9yIChjb25zdCBza3Ugb2YgT2JqZWN0LnZhbHVlcyh0aGlzLnNrdXMpKSB7XG4gICAgICAgICAgT2JqZWN0LmZyZWV6ZShza3UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsb2FkKCkge1xuICAgIHRoaXMuc3RhcnQoKTtcbiAgICBhd2FpdCB0aGlzLmRvbmU7XG4gICAgcmV0dXJuIHRoaXMuc2t1cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3BpZGVyKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoMyk7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCgyMDAxKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VMaXN0KDQ1KTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VEZXRhaWxzKFwiYmU5NTI2MTI2ZDM5NDA2MWIwZWVmOWIxNjM1MjM1N2VcIik7XG5cbiAgICB3aGlsZSAoT2JqZWN0LmtleXModGhpcy5za3VzKS5sZW5ndGggPiBPYmplY3Qua2V5cyh0aGlzLnNwaWRlcmVkKS5sZW5ndGgpIHtcbiAgICAgIGZvciAoY29uc3Qgc2t1IG9mIE9iamVjdC52YWx1ZXModGhpcy5za3VzKSkge1xuICAgICAgICBpZiAodGhpcy5zcGlkZXJlZFtza3Uuc2t1XSAhPT0gdHJ1ZSkge1xuICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJzcGlkZXJpbmcgXCIsIHNrdS5rZXkoKSwgc2t1KTtcbiAgICAgICAgICBhd2FpdCB0aGlzLmxvYWRTa3VEZXRhaWxzKHNrdS5za3UpO1xuICAgICAgICAgIHRoaXMuc3BpZGVyZWRbc2t1LnNrdV0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGRvd25sb2FkKCkge1xuICAgIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShcbiAgICAgIE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgICAgT2JqZWN0LnZhbHVlcyh0aGlzLnNrdXMpLm1hcCgoc2t1KSA9PiBbc2t1LmtleSgpLCBza3VdKVxuICAgICAgKSxcbiAgICAgIG51bGwsXG4gICAgICAyXG4gICAgKTtcbiAgICAvLyBYWFg6IHRoaXMgYmxvYiBpcyBsZWFrZWRcbiAgICBjb25zdCBocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChcbiAgICAgIG5ldyBCbG9iKFtqc29uXSwge1xuICAgICAgICB0eXBlOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBlbCA9IE9iamVjdC5hc3NpZ24oZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIiksIHtcbiAgICAgIGRvd25sb2FkOiBcInNrdXMuanNvblwiLFxuICAgICAgaHJlZixcbiAgICB9KTtcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsKTtcbiAgICBlbC5jbGljaygpO1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkU2t1TGlzdChudW1iZXI6IG51bWJlcikge1xuICAgIGF3YWl0IHRoaXMuZmV0Y2hQcmVsb2FkRGF0YShgc3RvcmUvbGlzdC8ke251bWJlcn1gKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFNrdURldGFpbHMoc2t1OiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmZldGNoUHJlbG9hZERhdGEoYHN0b3JlL2RldGFpbHMvXy9za3UvJHtza3V9YCk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRTa3VEYXRhKGRhdGE6IFByb3RvRGF0YSwgcHJpY2luZzogUHJvdG9EYXRhKTogU2t1IHtcbiAgICBjb25zdCB0eXBlSWQgPSBkYXRhWzZdO1xuXG4gICAgY29uc29sZS5sb2coeyBwcmljaW5nIH0pO1xuICAgIC8vIHByaWNpbmcgc2hvdWxkIGluY2x1ZGUgbm9ybWFsIHByaWNlLCBwcm8gcHJpY2UsXG4gICAgLy8gY3VycmVudCBzYWxlIHByaWNlcyBmb3IgZWFjaCwgdGhlIHN0YXJ0IGFuZCBlbmQgZGF0ZXMgb2YgZWFjaCBzYWxlXG5cbiAgICBsZXQgc2t1O1xuICAgIGlmICh0eXBlSWQgPT09IDEpIHtcbiAgICAgIHNrdSA9IG5ldyBHYW1lKGRhdGFbNF0sIGRhdGFbMF0sIFwiZ2FtZVwiLCBkYXRhWzFdKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVJZCA9PT0gMikge1xuICAgICAgc2t1ID0gbmV3IEFkZE9uKGRhdGFbNF0sIGRhdGFbMF0sIFwiYWRkb25cIiwgZGF0YVsxXSk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDMpIHtcbiAgICAgIHNrdSA9IG5ldyBCdW5kbGUoXG4gICAgICAgIGRhdGFbNF0sXG4gICAgICAgIGRhdGFbMF0sXG4gICAgICAgIFwiYnVuZGxlXCIsXG4gICAgICAgIGRhdGFbMV0sXG4gICAgICAgIGRhdGFbMTRdWzBdLm1hcCgoeCkgPT4geFswXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDUpIHtcbiAgICAgIHNrdSA9IG5ldyBTdWJzY3JpcHRpb24oXG4gICAgICAgIGRhdGFbNF0sXG4gICAgICAgIGRhdGFbMF0sXG4gICAgICAgIFwic3Vic2NyaXB0aW9uXCIsXG4gICAgICAgIGRhdGFbMV0sXG4gICAgICAgIGRhdGFbMTRdWzBdLm1hcCgoeCkgPT4geFswXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHVuZXhwZWN0ZWQgc2t1IHR5cGUgaWQgJHtKU09OLnN0cmluZ2lmeSh0eXBlSWQsIG51bGwsIDQpfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubG9hZFNrdShza3UpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkU2t1KHNrdTogU2t1KTogU2t1IHtcbiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuc2t1c1tza3Uuc2t1XTtcbiAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nSnNvbiA9IEpTT04uc3RyaW5naWZ5KGV4aXN0aW5nKTtcbiAgICAgIGNvbnN0IG5ld0pzb24gPSBKU09OLnN0cmluZ2lmeShza3UpO1xuICAgICAgaWYgKGV4aXN0aW5nSnNvbiAhPT0gbmV3SnNvbikge1xuICAgICAgICBjb25zb2xlLndhcm4oYHNrdXMgaGFkIHNhbWUgaWRzIGJ1dCBkaWZmZXJlbnQgcHJvcGVydGllcy5gKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihleGlzdGluZywgc2t1KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBleGlzdGluZztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5za3VzW3NrdS5za3VdID0gc2t1O1xuICAgICAgcmV0dXJuIHNrdTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmZXRjaFByZWxvYWREYXRhKHBhdGg6IHN0cmluZykge1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PlxuICAgICAgc2V0VGltZW91dChyZXNvbHZlLCBNYXRoLnJhbmRvbSgpICogM18wMDAgKyAyXzAwMClcbiAgICApO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goXCJodHRwczovL3N0YWRpYS5nb29nbGUuY29tL1wiICsgcGF0aCk7XG4gICAgY29uc3QgaHRtbCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICBjb25zdCBkb2N1bWVudCA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoaHRtbCwgXCJ0ZXh0L2h0bWxcIik7XG4gICAgY29uc3Qgc2NyaXB0cyA9IEFycmF5LmZyb20oZG9jdW1lbnQuc2NyaXB0cyk7XG4gICAgY29uc3QgY29udGVudHMgPSBzY3JpcHRzLm1hcCgocykgPT4gcy50ZXh0Q29udGVudC50cmltKCkpLmZpbHRlcihCb29sZWFuKTtcblxuICAgIGNvbnN0IGRhdGFTZXJ2aWNlUmVxdWVzdHNQYXR0ZXJuID0gL152YXIgKkFGX2luaXREYXRhS2V5c1teXSo/dmFyICpBRl9kYXRhU2VydmljZVJlcXVlc3RzICo9ICooe1teXSp9KTsgKj92YXIgLztcblxuICAgIGNvbnN0IGRhdGFTZXJ2aWNlUmVxdWVzdHMgPSBjb250ZW50c1xuICAgICAgLm1hcCgocykgPT4gcy5tYXRjaChkYXRhU2VydmljZVJlcXVlc3RzUGF0dGVybikpXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgICAubWFwKChtYXRjaGVzKSA9PlxuICAgICAgICBKU09OLnBhcnNlKFxuICAgICAgICAgIG1hdGNoZXNbMV1cbiAgICAgICAgICAgIC5yZXBsYWNlKC97aWQ6L2csICd7XCJpZFwiOicpXG4gICAgICAgICAgICAucmVwbGFjZSgvLHJlcXVlc3Q6L2csICcsXCJyZXF1ZXN0XCI6JylcbiAgICAgICAgICAgIC5yZXBsYWNlKC8nL2csICdcIicpXG4gICAgICAgIClcbiAgICAgIClcbiAgICAgIC5tYXAoKHJlcXVlc3RzKSA9PlxuICAgICAgICBPYmplY3QuZnJvbUVudHJpZXMoXG4gICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVxdWVzdHMpLm1hcCgoW2tleSwgdmFsdWVdOiBhbnkpID0+IFtrZXksIHZhbHVlXSlcbiAgICAgICAgKVxuICAgICAgKVswXTtcblxuICAgIGNvbnN0IGRhdGFDYWxsYmFja1BhdHRlcm4gPSAvXiAqQUZfaW5pdERhdGFDYWxsYmFjayAqXFwoICp7ICprZXkgKjogKidkczooWzAtOV0rPyknICosW15dKj9kYXRhOiAqZnVuY3Rpb24gKlxcKCAqXFwpeyAqcmV0dXJuICooW15dKilcXHMqfVxccyp9XFxzKlxcKVxccyo7P1xccyokLztcbiAgICBjb25zdCBkYXRhU2VydmljZUxvYWRzID0gW107XG4gICAgZm9yIChjb25zdCBtYXRjaGVzIG9mIGNvbnRlbnRzXG4gICAgICAubWFwKChzKSA9PiBzLm1hdGNoKGRhdGFDYWxsYmFja1BhdHRlcm4pKVxuICAgICAgLmZpbHRlcihCb29sZWFuKSkge1xuICAgICAgZGF0YVNlcnZpY2VMb2Fkc1ttYXRjaGVzWzFdXSA9IEpTT04ucGFyc2UobWF0Y2hlc1syXSk7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YVNlcnZpY2VScGNQcmVmaXhlcyA9IE9iamVjdC52YWx1ZXMoZGF0YVNlcnZpY2VSZXF1ZXN0cykubWFwKFxuICAgICAgKHg6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBwaWVjZXMgPSBbeC5pZCwgLi4ueC5yZXF1ZXN0XTtcbiAgICAgICAgY29uc3QgYWxpYXNlcyA9IFtdO1xuICAgICAgICBhbGlhc2VzLnB1c2goXG4gICAgICAgICAgYCR7cGllY2VzWzBdfV8ke3BpZWNlcy5maWx0ZXIoKHgpID0+IHggIT0gbnVsbCkubGVuZ3RoIC0gMX1zJHtcbiAgICAgICAgICAgIHBpZWNlcy5maWx0ZXIoQm9vbGVhbikubGVuZ3RoIC0gMVxuICAgICAgICAgIH10JHtwaWVjZXMubGVuZ3RoIC0gMX1hYFxuICAgICAgICApO1xuICAgICAgICB3aGlsZSAocGllY2VzLmxlbmd0aCkge1xuICAgICAgICAgIGFsaWFzZXMucHVzaChwaWVjZXMuam9pbihcIl9cIikpO1xuICAgICAgICAgIHBpZWNlcy5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWxpYXNlcztcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgcHJlbG9hZCA9IE9iamVjdC52YWx1ZXMoZGF0YVNlcnZpY2VMb2Fkcyk7XG4gICAgY29uc3QgcnBjID0ge307XG4gICAgY29uc3QgbG9hZGVkID0ge307XG5cbiAgICBjb25zdCBsb2FkZXJzID0ge1xuICAgICAgV3dEM3JiOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IHNrdXMgPSBkYXRhWzJdLm1hcCgocDogYW55KSA9PiB0aGlzLmxvYWRTa3VEYXRhKHBbOV0pKTtcbiAgICAgICAgcmV0dXJuIHsgc2t1cyB9O1xuICAgICAgfSxcblxuICAgICAgRldoUVZfMjRyOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IGdhbWVEYXRhID0gZGF0YVsxOF0/LlswXT8uWzldO1xuICAgICAgICBjb25zdCBnYW1lUHJpY2luZ0RhdGEgPSBkYXRhWzE4XT8uWzBdPy5bMTVdPy5bMF07XG4gICAgICAgIGNvbnN0IGdhbWUgPSBnYW1lRGF0YSAmJiB0aGlzLmxvYWRTa3VEYXRhKGdhbWVEYXRhLCBnYW1lUHJpY2luZ0RhdGEpO1xuXG4gICAgICAgIGNvbnN0IGFkZG9ucyA9IChkYXRhWzE5XSBhcyBhbnkpPy5tYXAoKHg6IGFueSkgPT5cbiAgICAgICAgICB0aGlzLmxvYWRTa3VEYXRhKHhbOV0pXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3Qgc2t1RGF0YSA9IGRhdGFbMTZdO1xuICAgICAgICBjb25zdCBza3VQcmljaW5nRGF0YSA9IGRhdGFbMjFdPy5bMF07XG4gICAgICAgIGNvbnN0IHNrdSA9IHNrdURhdGEgJiYgdGhpcy5sb2FkU2t1RGF0YShza3VEYXRhLCBza3VQcmljaW5nRGF0YSk7XG5cbiAgICAgICAgcmV0dXJuIHsgc2t1LCBnYW1lLCBhZGRvbnMgfTtcbiAgICAgIH0sXG5cbiAgICAgIFNZY3NUZDogKGRhdGE6IFByb3RvRGF0YSkgPT4ge1xuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25EYXRhcyA9IGRhdGFbMl0/Lm1hcCgoeCkgPT4geFs5XSkgPz8gW107XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBzdWJzY3JpcHRpb25EYXRhcy5tYXAoKHMpID0+IHRoaXMubG9hZFNrdURhdGEocykpO1xuICAgICAgICBpZiAoc3Vic2NyaXB0aW9ucz8ubGVuZ3RoKSByZXR1cm4geyBzdWJzY3JpcHRpb25zIH07XG4gICAgICAgIGVsc2UgcmV0dXJuIHt9O1xuICAgICAgfSxcblxuICAgICAgWkFtN1c6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3QgYnVuZGxlcyA9IGRhdGFbMV0ubWFwKCh4KSA9PiB0aGlzLmxvYWRTa3VEYXRhKHhbOV0pKTtcbiAgICAgICAgcmV0dXJuIHsgYnVuZGxlcyB9O1xuICAgICAgfSxcbiAgICB9O1xuXG4gICAgZm9yIChjb25zdCBbaSwgZGF0YV0gb2YgT2JqZWN0LmVudHJpZXMocHJlbG9hZCkpIHtcbiAgICAgIGZvciAoY29uc3QgcHJlZml4IG9mIGRhdGFTZXJ2aWNlUnBjUHJlZml4ZXNbaV0pIHtcbiAgICAgICAgZm9yIChjb25zdCBzdWZmaXggb2YgW1wiXCIsIFwiX1wiICsgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoICsgXCJyXCJdKSB7XG4gICAgICAgICAgcnBjW3ByZWZpeCArIHN1ZmZpeF0gPSBkYXRhO1xuICAgICAgICAgIGNvbnN0IGxvYWRlciA9IGxvYWRlcnNbcHJlZml4ICsgc3VmZml4XTtcbiAgICAgICAgICBpZiAobG9hZGVyKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGxvYWRlZCwgbG9hZGVyKGRhdGEpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIE9iamVjdC5jcmVhdGUoe1xuICAgICAgICBwcmVsb2FkLFxuICAgICAgICBycGMsXG4gICAgICB9KSxcbiAgICAgIGxvYWRlZFxuICAgICk7XG5cbiAgICBjb25zb2xlLmRlYnVnKHBhdGgsIGRhdGEpO1xuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbn1cblxuY2xhc3MgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgYXBwOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZTogXCJnYW1lXCIgfCBcImFkZG9uXCIgfCBcImJ1bmRsZVwiIHwgXCJzdWJzY3JpcHRpb25cIixcbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmdcbiAgKSB7fVxuXG4gIHB1YmxpYyBrZXkoKSB7XG4gICAgcmV0dXJuIGAke1xuICAgICAgeyBnYW1lOiBcImdcIiwgYWRkb246IFwib1wiLCBidW5kbGU6IFwieFwiLCBzdWJzY3JpcHRpb246IFwiYVwiIH1bdGhpcy50eXBlXSA/P1xuICAgICAgdGhpcy50eXBlXG4gICAgfSR7dGhpcy5hcHAuc2xpY2UoMCwgNil9JHt0aGlzLnNrdS5zbGljZSgwLCA0KX0ke3RoaXMubmFtZS5zbGljZShcbiAgICAgIE1hdGgubWF4KDAsIDAgfCAoKHRoaXMubmFtZS5sZW5ndGggLSAyMCkgLyAyKSksXG4gICAgICAyMFxuICAgICl9JHt0aGlzLnNrdS5zbGljZSg0KX1gXG4gICAgICAudG9Mb3dlckNhc2UoKVxuICAgICAgLnJlcGxhY2UoL1teYS16MC05XSsvZywgXCJcIilcbiAgICAgIC5zbGljZSgwLCAzMik7XG4gIH1cbn1cblxuY2xhc3MgR2FtZSBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcImdhbWVcIiBhcyBjb25zdCxcbiAgICBuYW1lOiBzdHJpbmdcbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUpO1xuICB9XG59XG5cbmNsYXNzIEFkZE9uIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiYWRkb25cIiBhcyBjb25zdCxcbiAgICBuYW1lOiBzdHJpbmdcbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUpO1xuICB9XG59XG5cbmNsYXNzIEJ1bmRsZSBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcImJ1bmRsZVwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBza3VzOiBBcnJheTxzdHJpbmc+XG4gICkge1xuICAgIHN1cGVyKGFwcCwgc2t1LCB0eXBlLCBuYW1lKTtcbiAgfVxufVxuXG5jbGFzcyBTdWJzY3JpcHRpb24gZXh0ZW5kcyBDb21tb25Ta3Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IHN0cmluZyxcbiAgICBza3U6IHN0cmluZyxcbiAgICByZWFkb25seSB0eXBlID0gXCJzdWJzY3JpcHRpb25cIiBhcyBjb25zdCxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgc2t1czogQXJyYXk8c3RyaW5nPlxuICApIHtcbiAgICBzdXBlcihhcHAsIHNrdSwgdHlwZSwgbmFtZSk7XG4gIH1cbn1cbiJdfQ==
