import { storage } from "./storage.js";
import * as records from "./records.js";
import { Game, AddOn, Bundle, Subscription } from "./data.js";
export const spider = async () => {
  const usage = await storage.usage();
  const schema = 20200202;
  if (schema !== (await storage.get("schema"))) {
    console.debug(`Resetting storage for schema ${schema}.`);
    await storage.clear();
    await storage.set("schema", schema);
  }
  console.debug(`Using ${usage} bytes of storage with schema ${schema}.`);
  await new Promise((resolve) => setTimeout(resolve, 10));
  try {
    const spider = new Spider();
    console.debug("starting spider", spider);
    const data = await spider.load();
    console.debug("completed spider", spider, data);
    spider.download();
    await storage.set("skus", spider.output());
  } catch (error) {
    console.error(error);
  }
};
class Spider {
  constructor(skus = {}, spidered = {}) {
    this.skus = skus;
    this.spidered = spidered;
    let start;
    const started = new Promise((resolve) => (start = resolve));
    this.start = start;
    this.done = started
      .then(() => this.spider())
      .then(() => {
        Object.freeze(this.skus);
        for (const sku of Object.values(this.skus)) {
          Object.freeze(sku);
        }
      });
  }
  async load() {
    this.start();
    await this.done;
    return this.output();
  }
  async spider() {
    await this.loadSkuDetails("59c8314ac82a456ba61d08988b15b550");
    await this.loadSkuDetails("b171fc78d4e1496d9536d585257a771e");
    await this.loadSkuDetails("4950959380034dcda0aecf98f675e11f");
    await this.loadSkuDetails("2e07db5d338d40cb9eac9deae4154f11");
    await this.loadSkuList(3);
    await this.loadSkuList(2001);
    await this.loadSkuList(45);
    await this.loadSkuList(6);
    console.warn(
      "TODO: re-enable spidering once we've finished the above tweaks."
    );
    return;
    while (Object.keys(this.skus).length > Object.keys(this.spidered).length) {
      for (const sku of Object.values(this.skus)) {
        if (this.spidered[sku.sku] !== true) {
          console.debug("spidering ", sku);
          await this.loadSkuDetails(sku.sku);
          this.spidered[sku.sku] = true;
        }
      }
    }
  }
  output() {
    return records.sorted(
      Object.fromEntries(
        Object.values(this.skus)
          .map((sku) => records.sorted(sku))
          .map((sku) => [sku.localKey, sku])
      )
    );
  }
  download() {
    const output = this.output();
    const json = JSON.stringify(output, null, 2);
    // XXX: this blob is leaked
    const href = URL.createObjectURL(
      new Blob([json], {
        type: "application/json",
      })
    );
    const el = Object.assign(document.createElement("a"), {
      download: "skus.json",
      href,
    });
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async loadSkuList(number) {
    await this.fetchPreloadData(`store/list/${number}`);
  }
  async loadSkuDetails(sku) {
    await this.fetchPreloadData(`store/details/_/sku/${sku}`);
  }
  loadSkuData(data, pricing) {
    const typeId = data[6];
    console.log({ pricing });
    // pricing should include normal price, pro price,
    // current sale prices for each, the start and end dates of each sale
    let sku;
    if (typeId === 1) {
      sku = new Game(data[4], data[0], "game", data[1], data[5], data[9]);
    } else if (typeId === 2) {
      sku = new AddOn(data[4], data[0], "addon", data[1], data[5], data[9]);
    } else if (typeId === 3) {
      sku = new Bundle(
        data[4],
        data[0],
        "bundle",
        data[1],
        data[5],
        data[9],
        data[14][0].map((x) => x[0])
      );
    } else if (typeId === 5) {
      sku = new Subscription(
        data[4],
        data[0],
        "subscription",
        data[1],
        data[5],
        data[9],
        data[14][0].map((x) => x[0])
      );
    } else {
      throw new Error(
        `unexpected sku type id ${JSON.stringify(typeId, null, 4)}`
      );
    }
    return this.loadSku(sku);
  }
  loadSku(sku) {
    const existing = this.skus[sku.sku];
    if (existing) {
      const existingJson = JSON.stringify(existing);
      const newJson = JSON.stringify(sku);
      if (existingJson !== newJson) {
        console.warn(`skus had same ids but different properties.`);
        Object.assign(existing, sku);
      }
      return existing;
    } else {
      this.skus[sku.sku] = sku;
      return sku;
    }
  }
  async fetchPreloadData(path) {
    await new Promise((resolve) =>
      setTimeout(resolve, Math.random() * 1000 + 2000)
    );
    const response = await fetch("https://stadia.google.com/" + path);
    const html = await response.text();
    const document = new DOMParser().parseFromString(html, "text/html");
    const scripts = Array.from(document.scripts);
    const contents = scripts.map((s) => s.textContent.trim()).filter(Boolean);
    const dataServiceRequestsPattern = /^var *AF_initDataKeys[^]*?var *AF_dataServiceRequests *= *({[^]*}); *?var /;
    const dataServiceRequests = contents
      .map((s) => s.match(dataServiceRequestsPattern))
      .filter(Boolean)
      .map((matches) =>
        JSON.parse(
          matches[1]
            .replace(/{id:/g, '{"id":')
            .replace(/,request:/g, ',"request":')
            .replace(/'/g, '"')
        )
      )
      .map((requests) =>
        Object.fromEntries(
          Object.entries(requests).map(([key, value]) => [key, value])
        )
      )[0];
    const dataCallbackPattern = /^ *AF_initDataCallback *\( *{ *key *: *'ds:([0-9]+?)' *,[^]*?data: *function *\( *\){ *return *([^]*)\s*}\s*}\s*\)\s*;?\s*$/;
    const dataServiceLoads = [];
    for (const matches of contents
      .map((s) => s.match(dataCallbackPattern))
      .filter(Boolean)) {
      dataServiceLoads[matches[1]] = JSON.parse(matches[2]);
    }
    6;
    const dataServiceRpcPrefixes = Object.values(dataServiceRequests).map(
      (x) => {
        const pieces = [x.id, ...x.request];
        const aliases = [];
        aliases.push(
          `${pieces[0]}_${pieces.filter((x) => x != null).length - 1}s${
            pieces.filter(Boolean).length - 1
          }t${pieces.length - 1}a`
        );
        while (pieces.length) {
          aliases.push(pieces.join("_"));
          pieces.pop();
        }
        return aliases;
      }
    );
    const preload = Object.values(dataServiceLoads);
    const rpc = {};
    const loaded = {};
    const loaders = {
      WwD3rb: (data) => {
        const skus = data[2].map((p) => this.loadSkuData(p[9]));
        return { skus };
      },
      FWhQV_24r: (data) => {
        const gameData = data[18]?.[0]?.[9];
        const gamePricingData = data[18]?.[0]?.[15]?.[0];
        const game = gameData && this.loadSkuData(gameData, gamePricingData);
        const addons = data[19]?.map((x) => this.loadSkuData(x[9]));
        const skuData = data[16];
        const skuPricingData = data[21]?.[0];
        const sku = skuData && this.loadSkuData(skuData, skuPricingData);
        return { sku, game, addons };
      },
      SYcsTd: (data) => {
        const subscriptionDatas = data[2]?.map((x) => x[9]) ?? [];
        const subscriptions = subscriptionDatas.map((s) => this.loadSkuData(s));
        if (subscriptions?.length) return { subscriptions };
        else return {};
      },
      ZAm7W: (data) => {
        const bundles = data[1].map((x) => this.loadSkuData(x[9]));
        return { bundles };
      },
    };
    for (const [i, data] of Object.entries(preload)) {
      for (const prefix of dataServiceRpcPrefixes[i]) {
        for (const suffix of ["", "_" + Object.keys(data).length + "r"]) {
          rpc[prefix + suffix] = data;
          const loader = loaders[prefix + suffix];
          if (loader) {
            Object.assign(loaded, loader(data));
          }
        }
      }
    }
    const data = Object.assign(
      Object.create({
        preload,
        rpc,
      }),
      loaded
    );
    console.debug(path, data);
    return data;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BpZGVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzcGlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEtBQUssT0FBTyxNQUFNLGNBQWMsQ0FBQztBQUN4QyxPQUFPLEVBQU8sSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5FLE1BQU0sQ0FBQyxNQUFNLE1BQU0sR0FBRyxLQUFLLElBQUksRUFBRTtJQUMvQixNQUFNLEtBQUssR0FBRyxNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNwQyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUM7SUFDeEIsSUFBSSxNQUFNLEtBQUssQ0FBQyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRTtRQUM1QyxPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ3pELE1BQU0sT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3RCLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDckM7SUFDRCxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsS0FBSyxpQ0FBaUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUV4RSxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEQsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7UUFDNUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6QyxNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FB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Q0FDUCxDQUFDO1FBRUYsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFMUIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzdG9yYWdlIH0gZnJvbSBcIi4vc3RvcmFnZS5qc1wiO1xuaW1wb3J0ICogYXMgcmVjb3JkcyBmcm9tIFwiLi9yZWNvcmRzLmpzXCI7XG5pbXBvcnQgeyBTa3UsIEdhbWUsIEFkZE9uLCBCdW5kbGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gXCIuL2RhdGEuanNcIjtcblxuZXhwb3J0IGNvbnN0IHNwaWRlciA9IGFzeW5jICgpID0+IHtcbiAgY29uc3QgdXNhZ2UgPSBhd2FpdCBzdG9yYWdlLnVzYWdlKCk7XG4gIGNvbnN0IHNjaGVtYSA9IDIwMjAwMjAyO1xuICBpZiAoc2NoZW1hICE9PSAoYXdhaXQgc3RvcmFnZS5nZXQoXCJzY2hlbWFcIikpKSB7XG4gICAgY29uc29sZS5kZWJ1ZyhgUmVzZXR0aW5nIHN0b3JhZ2UgZm9yIHNjaGVtYSAke3NjaGVtYX0uYCk7XG4gICAgYXdhaXQgc3RvcmFnZS5jbGVhcigpO1xuICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KFwic2NoZW1hXCIsIHNjaGVtYSk7XG4gIH1cbiAgY29uc29sZS5kZWJ1ZyhgVXNpbmcgJHt1c2FnZX0gYnl0ZXMgb2Ygc3RvcmFnZSB3aXRoIHNjaGVtYSAke3NjaGVtYX0uYCk7XG5cbiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTApKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBzcGlkZXIgPSBuZXcgU3BpZGVyKCk7XG4gICAgY29uc29sZS5kZWJ1ZyhcInN0YXJ0aW5nIHNwaWRlclwiLCBzcGlkZXIpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBzcGlkZXIubG9hZCgpO1xuICAgIGNvbnNvbGUuZGVidWcoXCJjb21wbGV0ZWQgc3BpZGVyXCIsIHNwaWRlciwgZGF0YSk7XG4gICAgc3BpZGVyLmRvd25sb2FkKCk7XG4gICAgYXdhaXQgc3RvcmFnZS5zZXQoXCJza3VzXCIsIHNwaWRlci5vdXRwdXQoKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gIH1cbn07XG5cbnR5cGUgUHJvdG9EYXRhID0gYW55ICYgQXJyYXk8UHJvdG9EYXRhIHwgbnVtYmVyIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bGw+O1xuXG5jbGFzcyBTcGlkZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YXJ0OiAoKSA9PiB2b2lkO1xuICBwcml2YXRlIHJlYWRvbmx5IGRvbmU6IFByb21pc2U8dW5rbm93bj47XG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNrdXM6IFJlY29yZDxTa3VbXCJza3VcIl0sIFNrdT4gPSB7fSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNwaWRlcmVkOiBSZWNvcmQ8U2t1W1wic2t1XCJdLCB0cnVlPiA9IHt9XG4gICkge1xuICAgIGxldCBzdGFydDogKCkgPT4gdm9pZDtcbiAgICBjb25zdCBzdGFydGVkID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IChzdGFydCA9IHJlc29sdmUpKTtcbiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQ7XG4gICAgdGhpcy5kb25lID0gc3RhcnRlZFxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zcGlkZXIoKSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzLnNrdXMpO1xuICAgICAgICBmb3IgKGNvbnN0IHNrdSBvZiBPYmplY3QudmFsdWVzKHRoaXMuc2t1cykpIHtcbiAgICAgICAgICBPYmplY3QuZnJlZXplKHNrdSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxvYWQoKSB7XG4gICAgdGhpcy5zdGFydCgpO1xuICAgIGF3YWl0IHRoaXMuZG9uZTtcbiAgICByZXR1cm4gdGhpcy5vdXRwdXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3BpZGVyKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdURldGFpbHMoXCI1OWM4MzE0YWM4MmE0NTZiYTYxZDA4OTg4YjE1YjU1MFwiKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VEZXRhaWxzKFwiYjE3MWZjNzhkNGUxNDk2ZDk1MzZkNTg1MjU3YTc3MWVcIik7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhcIjQ5NTA5NTkzODAwMzRkY2RhMGFlY2Y5OGY2NzVlMTFmXCIpO1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdURldGFpbHMoXCIyZTA3ZGI1ZDMzOGQ0MGNiOWVhYzlkZWFlNDE1NGYxMVwiKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VMaXN0KDMpO1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoMjAwMSk7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCg0NSk7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCg2KTtcblxuICAgIGNvbnNvbGUud2FybihcbiAgICAgIFwiVE9ETzogcmUtZW5hYmxlIHNwaWRlcmluZyBvbmNlIHdlJ3ZlIGZpbmlzaGVkIHRoZSBhYm92ZSB0d2Vha3MuXCJcbiAgICApO1xuICAgIHJldHVybjtcbiAgICB3aGlsZSAoT2JqZWN0LmtleXModGhpcy5za3VzKS5sZW5ndGggPiBPYmplY3Qua2V5cyh0aGlzLnNwaWRlcmVkKS5sZW5ndGgpIHtcbiAgICAgIGZvciAoY29uc3Qgc2t1IG9mIE9iamVjdC52YWx1ZXModGhpcy5za3VzKSkge1xuICAgICAgICBpZiAodGhpcy5zcGlkZXJlZFtza3Uuc2t1XSAhPT0gdHJ1ZSkge1xuICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJzcGlkZXJpbmcgXCIsIHNrdSk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhza3Uuc2t1KTtcbiAgICAgICAgICB0aGlzLnNwaWRlcmVkW3NrdS5za3VdID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvdXRwdXQoKSB7XG4gICAgcmV0dXJuIHJlY29yZHMuc29ydGVkKFxuICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICBPYmplY3QudmFsdWVzKHRoaXMuc2t1cylcbiAgICAgICAgICAubWFwKChza3UpID0+IHJlY29yZHMuc29ydGVkKHNrdSkpXG4gICAgICAgICAgLm1hcCgoc2t1KSA9PiBbc2t1LmxvY2FsS2V5LCBza3VdKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZG93bmxvYWQoKSB7XG4gICAgY29uc3Qgb3V0cHV0ID0gdGhpcy5vdXRwdXQoKTtcbiAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkob3V0cHV0LCBudWxsLCAyKTtcbiAgICAvLyBYWFg6IHRoaXMgYmxvYiBpcyBsZWFrZWRcbiAgICBjb25zdCBocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChcbiAgICAgIG5ldyBCbG9iKFtqc29uXSwge1xuICAgICAgICB0eXBlOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBlbCA9IE9iamVjdC5hc3NpZ24oZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIiksIHtcbiAgICAgIGRvd25sb2FkOiBcInNrdXMuanNvblwiLFxuICAgICAgaHJlZixcbiAgICB9KTtcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsKTtcbiAgICBlbC5jbGljaygpO1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkU2t1TGlzdChudW1iZXI6IG51bWJlcikge1xuICAgIGF3YWl0IHRoaXMuZmV0Y2hQcmVsb2FkRGF0YShgc3RvcmUvbGlzdC8ke251bWJlcn1gKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFNrdURldGFpbHMoc2t1OiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmZldGNoUHJlbG9hZERhdGEoYHN0b3JlL2RldGFpbHMvXy9za3UvJHtza3V9YCk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRTa3VEYXRhKGRhdGE6IFByb3RvRGF0YSwgcHJpY2luZzogUHJvdG9EYXRhKTogU2t1IHtcbiAgICBjb25zdCB0eXBlSWQgPSBkYXRhWzZdO1xuXG4gICAgY29uc29sZS5sb2coeyBwcmljaW5nIH0pO1xuICAgIC8vIHByaWNpbmcgc2hvdWxkIGluY2x1ZGUgbm9ybWFsIHByaWNlLCBwcm8gcHJpY2UsXG4gICAgLy8gY3VycmVudCBzYWxlIHByaWNlcyBmb3IgZWFjaCwgdGhlIHN0YXJ0IGFuZCBlbmQgZGF0ZXMgb2YgZWFjaCBzYWxlXG5cbiAgICBsZXQgc2t1O1xuICAgIGlmICh0eXBlSWQgPT09IDEpIHtcbiAgICAgIHNrdSA9IG5ldyBHYW1lKGRhdGFbNF0sIGRhdGFbMF0sIFwiZ2FtZVwiLCBkYXRhWzFdLCBkYXRhWzVdLCBkYXRhWzldKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVJZCA9PT0gMikge1xuICAgICAgc2t1ID0gbmV3IEFkZE9uKGRhdGFbNF0sIGRhdGFbMF0sIFwiYWRkb25cIiwgZGF0YVsxXSwgZGF0YVs1XSwgZGF0YVs5XSk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDMpIHtcbiAgICAgIHNrdSA9IG5ldyBCdW5kbGUoXG4gICAgICAgIGRhdGFbNF0sXG4gICAgICAgIGRhdGFbMF0sXG4gICAgICAgIFwiYnVuZGxlXCIsXG4gICAgICAgIGRhdGFbMV0sXG4gICAgICAgIGRhdGFbNV0sXG4gICAgICAgIGRhdGFbOV0sXG4gICAgICAgIGRhdGFbMTRdWzBdLm1hcCgoeDogYW55KSA9PiB4WzBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVJZCA9PT0gNSkge1xuICAgICAgc2t1ID0gbmV3IFN1YnNjcmlwdGlvbihcbiAgICAgICAgZGF0YVs0XSxcbiAgICAgICAgZGF0YVswXSxcbiAgICAgICAgXCJzdWJzY3JpcHRpb25cIixcbiAgICAgICAgZGF0YVsxXSxcbiAgICAgICAgZGF0YVs1XSxcbiAgICAgICAgZGF0YVs5XSxcbiAgICAgICAgZGF0YVsxNF1bMF0ubWFwKCh4OiBhbnkpID0+IHhbMF0pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGB1bmV4cGVjdGVkIHNrdSB0eXBlIGlkICR7SlNPTi5zdHJpbmdpZnkodHlwZUlkLCBudWxsLCA0KX1gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmxvYWRTa3Uoc2t1KTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFNrdShza3U6IFNrdSk6IFNrdSB7XG4gICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLnNrdXNbc2t1LnNrdV07XG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICBjb25zdCBleGlzdGluZ0pzb24gPSBKU09OLnN0cmluZ2lmeShleGlzdGluZyk7XG4gICAgICBjb25zdCBuZXdKc29uID0gSlNPTi5zdHJpbmdpZnkoc2t1KTtcbiAgICAgIGlmIChleGlzdGluZ0pzb24gIT09IG5ld0pzb24pIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBza3VzIGhhZCBzYW1lIGlkcyBidXQgZGlmZmVyZW50IHByb3BlcnRpZXMuYCk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZXhpc3RpbmcsIHNrdSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZXhpc3Rpbmc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2t1c1tza3Uuc2t1XSA9IHNrdTtcbiAgICAgIHJldHVybiBza3U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmV0Y2hQcmVsb2FkRGF0YShwYXRoOiBzdHJpbmcpIHtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT5cbiAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgTWF0aC5yYW5kb20oKSAqIDFfMDAwICsgMl8wMDApXG4gICAgKTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFwiaHR0cHM6Ly9zdGFkaWEuZ29vZ2xlLmNvbS9cIiArIHBhdGgpO1xuICAgIGNvbnN0IGh0bWwgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG4gICAgY29uc3QgZG9jdW1lbnQgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGh0bWwsIFwidGV4dC9odG1sXCIpO1xuICAgIGNvbnN0IHNjcmlwdHMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnNjcmlwdHMpO1xuICAgIGNvbnN0IGNvbnRlbnRzID0gc2NyaXB0cy5tYXAoKHMpID0+IHMudGV4dENvbnRlbnQudHJpbSgpKS5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICBjb25zdCBkYXRhU2VydmljZVJlcXVlc3RzUGF0dGVybiA9IC9edmFyICpBRl9pbml0RGF0YUtleXNbXl0qP3ZhciAqQUZfZGF0YVNlcnZpY2VSZXF1ZXN0cyAqPSAqKHtbXl0qfSk7ICo/dmFyIC87XG5cbiAgICBjb25zdCBkYXRhU2VydmljZVJlcXVlc3RzID0gY29udGVudHNcbiAgICAgIC5tYXAoKHMpID0+IHMubWF0Y2goZGF0YVNlcnZpY2VSZXF1ZXN0c1BhdHRlcm4pKVxuICAgICAgLmZpbHRlcihCb29sZWFuKVxuICAgICAgLm1hcCgobWF0Y2hlcykgPT5cbiAgICAgICAgSlNPTi5wYXJzZShcbiAgICAgICAgICBtYXRjaGVzWzFdXG4gICAgICAgICAgICAucmVwbGFjZSgve2lkOi9nLCAne1wiaWRcIjonKVxuICAgICAgICAgICAgLnJlcGxhY2UoLyxyZXF1ZXN0Oi9nLCAnLFwicmVxdWVzdFwiOicpXG4gICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAnXCInKVxuICAgICAgICApXG4gICAgICApXG4gICAgICAubWFwKChyZXF1ZXN0cykgPT5cbiAgICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlcXVlc3RzKS5tYXAoKFtrZXksIHZhbHVlXTogYW55KSA9PiBba2V5LCB2YWx1ZV0pXG4gICAgICAgIClcbiAgICAgIClbMF07XG5cbiAgICBjb25zdCBkYXRhQ2FsbGJhY2tQYXR0ZXJuID0gL14gKkFGX2luaXREYXRhQ2FsbGJhY2sgKlxcKCAqeyAqa2V5ICo6IConZHM6KFswLTldKz8pJyAqLFteXSo/ZGF0YTogKmZ1bmN0aW9uICpcXCggKlxcKXsgKnJldHVybiAqKFteXSopXFxzKn1cXHMqfVxccypcXClcXHMqOz9cXHMqJC87XG4gICAgY29uc3QgZGF0YVNlcnZpY2VMb2FkczogQXJyYXk8YW55PiA9IFtdO1xuICAgIGZvciAoY29uc3QgbWF0Y2hlcyBvZiBjb250ZW50c1xuICAgICAgLm1hcCgocykgPT4gcy5tYXRjaChkYXRhQ2FsbGJhY2tQYXR0ZXJuKSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbikpIHtcbiAgICAgIGRhdGFTZXJ2aWNlTG9hZHNbbWF0Y2hlc1sxXV0gPSBKU09OLnBhcnNlKG1hdGNoZXNbMl0pO1xuICAgIH1cbiAgICA2O1xuICAgIGNvbnN0IGRhdGFTZXJ2aWNlUnBjUHJlZml4ZXMgPSBPYmplY3QudmFsdWVzKGRhdGFTZXJ2aWNlUmVxdWVzdHMpLm1hcChcbiAgICAgICh4OiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgcGllY2VzID0gW3guaWQsIC4uLngucmVxdWVzdF07XG4gICAgICAgIGNvbnN0IGFsaWFzZXMgPSBbXTtcbiAgICAgICAgYWxpYXNlcy5wdXNoKFxuICAgICAgICAgIGAke3BpZWNlc1swXX1fJHtwaWVjZXMuZmlsdGVyKCh4OiBhbnkpID0+IHggIT0gbnVsbCkubGVuZ3RoIC0gMX1zJHtcbiAgICAgICAgICAgIHBpZWNlcy5maWx0ZXIoQm9vbGVhbikubGVuZ3RoIC0gMVxuICAgICAgICAgIH10JHtwaWVjZXMubGVuZ3RoIC0gMX1hYFxuICAgICAgICApO1xuICAgICAgICB3aGlsZSAocGllY2VzLmxlbmd0aCkge1xuICAgICAgICAgIGFsaWFzZXMucHVzaChwaWVjZXMuam9pbihcIl9cIikpO1xuICAgICAgICAgIHBpZWNlcy5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWxpYXNlcztcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgcHJlbG9hZCA9IE9iamVjdC52YWx1ZXMoZGF0YVNlcnZpY2VMb2Fkcyk7XG4gICAgY29uc3QgcnBjOiBhbnkgPSB7fTtcbiAgICBjb25zdCBsb2FkZWQgPSB7fTtcblxuICAgIGNvbnN0IGxvYWRlcnM6IGFueSA9IHtcbiAgICAgIFd3RDNyYjogKGRhdGE6IFByb3RvRGF0YSkgPT4ge1xuICAgICAgICBjb25zdCBza3VzID0gZGF0YVsyXS5tYXAoKHA6IGFueSkgPT4gdGhpcy5sb2FkU2t1RGF0YShwWzldKSk7XG4gICAgICAgIHJldHVybiB7IHNrdXMgfTtcbiAgICAgIH0sXG5cbiAgICAgIEZXaFFWXzI0cjogKGRhdGE6IFByb3RvRGF0YSkgPT4ge1xuICAgICAgICBjb25zdCBnYW1lRGF0YSA9IGRhdGFbMThdPy5bMF0/Lls5XTtcbiAgICAgICAgY29uc3QgZ2FtZVByaWNpbmdEYXRhID0gZGF0YVsxOF0/LlswXT8uWzE1XT8uWzBdO1xuICAgICAgICBjb25zdCBnYW1lID0gZ2FtZURhdGEgJiYgdGhpcy5sb2FkU2t1RGF0YShnYW1lRGF0YSwgZ2FtZVByaWNpbmdEYXRhKTtcblxuICAgICAgICBjb25zdCBhZGRvbnMgPSAoZGF0YVsxOV0gYXMgYW55KT8ubWFwKCh4OiBhbnkpID0+XG4gICAgICAgICAgdGhpcy5sb2FkU2t1RGF0YSh4WzldKVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHNrdURhdGEgPSBkYXRhWzE2XTtcbiAgICAgICAgY29uc3Qgc2t1UHJpY2luZ0RhdGEgPSBkYXRhWzIxXT8uWzBdO1xuICAgICAgICBjb25zdCBza3UgPSBza3VEYXRhICYmIHRoaXMubG9hZFNrdURhdGEoc2t1RGF0YSwgc2t1UHJpY2luZ0RhdGEpO1xuXG4gICAgICAgIHJldHVybiB7IHNrdSwgZ2FtZSwgYWRkb25zIH07XG4gICAgICB9LFxuXG4gICAgICBTWWNzVGQ6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uRGF0YXMgPSBkYXRhWzJdPy5tYXAoKHg6IGFueSkgPT4geFs5XSkgPz8gW107XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBzdWJzY3JpcHRpb25EYXRhcy5tYXAoKHMpID0+IHRoaXMubG9hZFNrdURhdGEocykpO1xuICAgICAgICBpZiAoc3Vic2NyaXB0aW9ucz8ubGVuZ3RoKSByZXR1cm4geyBzdWJzY3JpcHRpb25zIH07XG4gICAgICAgIGVsc2UgcmV0dXJuIHt9O1xuICAgICAgfSxcblxuICAgICAgWkFtN1c6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3QgYnVuZGxlcyA9IGRhdGFbMV0ubWFwKCh4OiBhbnkpID0+IHRoaXMubG9hZFNrdURhdGEoeFs5XSkpO1xuICAgICAgICByZXR1cm4geyBidW5kbGVzIH07XG4gICAgICB9LFxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IFtpLCBkYXRhXSBvZiBPYmplY3QuZW50cmllcyhwcmVsb2FkKSkge1xuICAgICAgZm9yIChjb25zdCBwcmVmaXggb2YgZGF0YVNlcnZpY2VScGNQcmVmaXhlc1tpXSkge1xuICAgICAgICBmb3IgKGNvbnN0IHN1ZmZpeCBvZiBbXCJcIiwgXCJfXCIgKyBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGggKyBcInJcIl0pIHtcbiAgICAgICAgICBycGNbcHJlZml4ICsgc3VmZml4XSA9IGRhdGE7XG4gICAgICAgICAgY29uc3QgbG9hZGVyID0gbG9hZGVyc1twcmVmaXggKyBzdWZmaXhdO1xuICAgICAgICAgIGlmIChsb2FkZXIpIHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24obG9hZGVkLCBsb2FkZXIoZGF0YSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKFxuICAgICAgT2JqZWN0LmNyZWF0ZSh7XG4gICAgICAgIHByZWxvYWQsXG4gICAgICAgIHJwYyxcbiAgICAgIH0pLFxuICAgICAgbG9hZGVkXG4gICAgKTtcblxuICAgIGNvbnNvbGUuZGVidWcocGF0aCwgZGF0YSk7XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxufVxuIl19
