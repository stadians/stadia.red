export const spider = async () => {
  await new Promise((resolve) => setTimeout(resolve, 10));
  try {
    const spider = new Spider();
    window["spider"] = spider;
    console.debug("starting spider", spider);
    const data = await spider.load();
    console.debug("completed spider", spider, data);
    spider.download();
  } catch (error) {
    console.error(error);
  }
};
class Spider {
  constructor(skus = {}, spidered = {}) {
    this.skus = skus;
    this.spidered = spidered;
    let start;
    const started = new Promise((resolve) => (start = resolve));
    this.start = start;
    this.done = started
      .then(() => this.spider())
      .then(() => {
        Object.freeze(this.skus);
        for (const sku of Object.values(this.skus)) {
          Object.freeze(sku);
        }
      });
  }
  async load() {
    this.start();
    await this.done;
    return this.skus;
  }
  async spider() {
    await this.loadSkuList(3);
    await this.loadSkuList(2001);
    await this.loadSkuList(45);
    await this.loadSkuDetails("be9526126d394061b0eef9b16352357e");
    while (Object.keys(this.skus).length > Object.keys(this.spidered).length) {
      for (const sku of Object.values(this.skus)) {
        if (this.spidered[sku.sku] !== true) {
          console.debug("spidering ", sku.key(), sku);
          await this.loadSkuDetails(sku.sku);
          this.spidered[sku.sku] = true;
        }
      }
    }
  }
  download() {
    const json = JSON.stringify(
      Object.fromEntries(
        Object.values(this.skus).map((sku) => [sku.key(), sku])
      ),
      null,
      2
    );
    // XXX: this blob is leaked
    const href = URL.createObjectURL(
      new Blob([json], {
        type: "application/json",
      })
    );
    const el = Object.assign(document.createElement("a"), {
      download: "skus.json",
      href,
    });
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async loadSkuList(number) {
    await this.fetchPreloadData(`store/list/${number}`);
  }
  async loadSkuDetails(sku) {
    await this.fetchPreloadData(`store/details/_/sku/${sku}`);
  }
  loadSkuData(data, pricing) {
    const typeId = data[6];
    console.log({ pricing });
    // pricing should include normal price, pro price,
    // current sale prices for each, the start and end dates of each sale
    let sku;
    if (typeId === 1) {
      sku = new Game(data[4], data[0], "game", data[1]);
    } else if (typeId === 2) {
      sku = new AddOn(data[4], data[0], "addon", data[1]);
    } else if (typeId === 3) {
      sku = new Bundle(
        data[4],
        data[0],
        "bundle",
        data[1],
        data[14][0].map((x) => x[0])
      );
    } else if (typeId === 5) {
      sku = new Subscription(
        data[4],
        data[0],
        "subscription",
        data[1],
        data[14][0].map((x) => x[0])
      );
    } else {
      throw new Error(
        `unexpected sku type id ${JSON.stringify(typeId, null, 4)}`
      );
    }
    return this.loadSku(sku);
  }
  loadSku(sku) {
    const existing = this.skus[sku.sku];
    if (existing) {
      if (JSON.stringify(existing) !== JSON.stringify(sku)) {
        const error = new Error(`skus had same sku but different values`);
        console.error(error);
        console.error(existing, sku);
        throw error;
      }
      return existing;
    } else {
      this.skus[sku.sku] = sku;
      return sku;
    }
  }
  async fetchPreloadData(path) {
    await new Promise((resolve) =>
      setTimeout(resolve, Math.random() * 3000 + 2000)
    );
    const response = await fetch("https://stadia.google.com/" + path);
    const html = await response.text();
    const document = new DOMParser().parseFromString(html, "text/html");
    const scripts = Array.from(document.scripts);
    const contents = scripts.map((s) => s.textContent.trim()).filter(Boolean);
    const dataServiceRequestsPattern = /^var *AF_initDataKeys[^]*?var *AF_dataServiceRequests *= *({[^]*}); *?var /;
    const dataServiceRequests = contents
      .map((s) => s.match(dataServiceRequestsPattern))
      .filter(Boolean)
      .map((matches) =>
        JSON.parse(
          matches[1]
            .replace(/{id:/g, '{"id":')
            .replace(/,request:/g, ',"request":')
            .replace(/'/g, '"')
        )
      )
      .map((requests) =>
        Object.fromEntries(
          Object.entries(requests).map(([key, value]) => [key, value])
        )
      )[0];
    const dataCallbackPattern = /^ *AF_initDataCallback *\( *{ *key *: *'ds:([0-9]+?)' *,[^]*?data: *function *\( *\){ *return *([^]*)\s*}\s*}\s*\)\s*;?\s*$/;
    const dataServiceLoads = [];
    for (const matches of contents
      .map((s) => s.match(dataCallbackPattern))
      .filter(Boolean)) {
      dataServiceLoads[matches[1]] = JSON.parse(matches[2]);
    }
    const dataServiceRpcPrefixes = Object.values(dataServiceRequests).map(
      (x) => {
        const pieces = [x.id, ...x.request];
        const aliases = [];
        aliases.push(
          `${pieces[0]}_${pieces.filter((x) => x != null).length - 1}s${
            pieces.filter(Boolean).length - 1
          }t${pieces.length - 1}a`
        );
        while (pieces.length) {
          aliases.push(pieces.join("_"));
          pieces.pop();
        }
        return aliases;
      }
    );
    const preload = Object.values(dataServiceLoads);
    const rpc = {};
    const loaded = {};
    const loaders = {
      WwD3rb: (data) => {
        const skus = data[2].map((p) => this.loadSkuData(p[9]));
        return { skus };
      },
      FWhQV_24r: (data) => {
        const gameData = data[18]?.[0]?.[9];
        const gamePricingData = data[18]?.[0]?.[15]?.[0];
        const game = gameData && this.loadSkuData(gameData, gamePricingData);
        const addons = data[19]?.map((x) => this.loadSkuData(x[9]));
        const skuData = data[16];
        const skuPricingData = data[21]?.[0];
        const sku = skuData && this.loadSkuData(skuData, skuPricingData);
        return { sku, game, addons };
      },
      SYcsTd: (data) => {
        const subscriptionDatas = data[2]?.map((x) => x[9]) ?? [];
        const subscriptions = subscriptionDatas.map((s) => this.loadSkuData(s));
        if (subscriptions?.length) return { subscriptions };
        else return {};
      },
      ZAm7W: (data) => {
        const bundles = data[1].map((x) => this.loadSkuData(x[9]));
        return { bundles };
      },
    };
    for (const [i, data] of Object.entries(preload)) {
      for (const prefix of dataServiceRpcPrefixes[i]) {
        for (const suffix of ["", "_" + Object.keys(data).length + "r"]) {
          rpc[prefix + suffix] = data;
          const loader = loaders[prefix + suffix];
          if (loader) {
            Object.assign(loaded, loader(data));
          }
        }
      }
    }
    const data = Object.assign(
      Object.create({
        preload,
        rpc,
      }),
      loaded
    );
    console.debug(path, data);
    return data;
  }
}
class CommonSku {
  constructor(app, sku, type, name) {
    this.app = app;
    this.sku = sku;
    this.type = type;
    this.name = name;
  }
  key() {
    return `${
      { game: "g", addon: "o", bundle: "x", subscription: "a" }[this.type] ??
      this.type
    }${this.app.slice(0, 6)}${this.sku.slice(0, 4)}${this.name.slice(
      Math.max(0, 0 | ((this.name.length - 20) / 2)),
      20
    )}${this.sku.slice(4)}`
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "")
      .slice(0, 32);
  }
}
class Game extends CommonSku {
  constructor(app, sku, type = "game", name) {
    super(app, sku, type, name);
    this.type = type;
  }
}
class AddOn extends CommonSku {
  constructor(app, sku, type = "addon", name) {
    super(app, sku, type, name);
    this.type = type;
  }
}
class Bundle extends CommonSku {
  constructor(app, sku, type = "bundle", name, skus) {
    super(app, sku, type, name);
    this.type = type;
    this.skus = skus;
  }
}
class Subscription extends CommonSku {
  constructor(app, sku, type = "subscription", name, skus) {
    super(app, sku, type, name);
    this.type = type;
    this.skus = skus;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BpZGVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzcGlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHLEtBQUssSUFBSSxFQUFFO0lBQy9CLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4RCxJQUFJO1FBQ0YsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUM1QixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQzFCLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDekMsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEQsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQ25CO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3RCO0FBQ0gsQ0FBQyxDQUFDO0FBS0YsTUFBTSxNQUFNO0lBR1YsWUFDbUIsT0FBZ0MsRUFBRSxFQUNsQyxXQUFxQyxFQUFFO1FBRHZDLFNBQUksR0FBSixJQUFJLENBQThCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQStCO1FBRXhELElBQUksS0FBaUIsQ0FBQztRQUN0QixNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLE9B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QUUsSUFBSSxDQUFDLENBQUM7UUFIbkIsU0FBSSxHQUFKLElBQUksQ0FBbUI7SUFJbEMsQ0FBQztDQUNGO0FBRUQsTUFBTSxNQUFPLFNBQVEsU0FBUztJQUM1QixZQUNFLEdBQVcsRUFDWCxHQUFXLEVBQ0YsT0FBTyxRQUFpQixFQUNqQyxJQUFZLEVBQ0gsSUFBbUI7UUFFNUIsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSm5CLFNBQUksR0FBSixJQUFJLENBQW9CO1FBRXhCLFNBQUksR0FBSixJQUFJLENBQWU7SUFHOUIsQ0FBQztDQUNGO0FBRUQsTUFBTSxZQUFhLFNBQVEsU0FBUztJQUNsQyxZQUNFLEdBQVcsRUFDWCxHQUFXLEVBQ0YsT0FBTyxjQUF1QixFQUN2QyxJQUFZLEVBQ0gsSUFBbUI7UUFFNUIsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBSm5CLFNBQUksR0FBSixJQUFJLENBQTBCO1FBRTlCLFNBQUksR0FBSixJQUFJLENBQWU7SUFHOUIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNvbnN0IHNwaWRlciA9IGFzeW5jICgpID0+IHtcbiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTApKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBzcGlkZXIgPSBuZXcgU3BpZGVyKCk7XG4gICAgd2luZG93W1wic3BpZGVyXCJdID0gc3BpZGVyO1xuICAgIGNvbnNvbGUuZGVidWcoXCJzdGFydGluZyBzcGlkZXJcIiwgc3BpZGVyKTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgc3BpZGVyLmxvYWQoKTtcbiAgICBjb25zb2xlLmRlYnVnKFwiY29tcGxldGVkIHNwaWRlclwiLCBzcGlkZXIsIGRhdGEpO1xuICAgIHNwaWRlci5kb3dubG9hZCgpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICB9XG59O1xuXG50eXBlIFByb3RvRGF0YSA9IGFueSAmIEFycmF5PFByb3RvRGF0YSB8IG51bWJlciB8IHN0cmluZyB8IGJvb2xlYW4gfCBudWxsPjtcbnR5cGUgU2t1ID0gR2FtZSB8IEFkZE9uIHwgQnVuZGxlIHwgU3Vic2NyaXB0aW9uO1xuXG5jbGFzcyBTcGlkZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YXJ0OiAoKSA9PiB2b2lkO1xuICBwcml2YXRlIHJlYWRvbmx5IGRvbmU6IFByb21pc2U8dW5rbm93bj47XG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNrdXM6IFJlY29yZDxTa3VbXCJza3VcIl0sIFNrdT4gPSB7fSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNwaWRlcmVkOiBSZWNvcmQ8U2t1W1wic2t1XCJdLCB0cnVlPiA9IHt9XG4gICkge1xuICAgIGxldCBzdGFydDogKCkgPT4gdm9pZDtcbiAgICBjb25zdCBzdGFydGVkID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IChzdGFydCA9IHJlc29sdmUpKTtcbiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQ7XG4gICAgdGhpcy5kb25lID0gc3RhcnRlZFxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zcGlkZXIoKSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzLnNrdXMpO1xuICAgICAgICBmb3IgKGNvbnN0IHNrdSBvZiBPYmplY3QudmFsdWVzKHRoaXMuc2t1cykpIHtcbiAgICAgICAgICBPYmplY3QuZnJlZXplKHNrdSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxvYWQoKSB7XG4gICAgdGhpcy5zdGFydCgpO1xuICAgIGF3YWl0IHRoaXMuZG9uZTtcbiAgICByZXR1cm4gdGhpcy5za3VzO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzcGlkZXIoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCgzKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRTa3VMaXN0KDIwMDEpO1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoNDUpO1xuICAgIGF3YWl0IHRoaXMubG9hZFNrdURldGFpbHMoXCJiZTk1MjYxMjZkMzk0MDYxYjBlZWY5YjE2MzUyMzU3ZVwiKTtcblxuICAgIHdoaWxlIChPYmplY3Qua2V5cyh0aGlzLnNrdXMpLmxlbmd0aCA+IE9iamVjdC5rZXlzKHRoaXMuc3BpZGVyZWQpLmxlbmd0aCkge1xuICAgICAgZm9yIChjb25zdCBza3Ugb2YgT2JqZWN0LnZhbHVlcyh0aGlzLnNrdXMpKSB7XG4gICAgICAgIGlmICh0aGlzLnNwaWRlcmVkW3NrdS5za3VdICE9PSB0cnVlKSB7XG4gICAgICAgICAgY29uc29sZS5kZWJ1ZyhcInNwaWRlcmluZyBcIiwgc2t1LmtleSgpLCBza3UpO1xuICAgICAgICAgIGF3YWl0IHRoaXMubG9hZFNrdURldGFpbHMoc2t1LnNrdSk7XG4gICAgICAgICAgdGhpcy5zcGlkZXJlZFtza3Uuc2t1XSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZG93bmxvYWQoKSB7XG4gICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICBPYmplY3QudmFsdWVzKHRoaXMuc2t1cykubWFwKChza3UpID0+IFtza3Uua2V5KCksIHNrdV0pXG4gICAgICApLFxuICAgICAgbnVsbCxcbiAgICAgIDJcbiAgICApO1xuICAgIC8vIFhYWDogdGhpcyBibG9iIGlzIGxlYWtlZFxuICAgIGNvbnN0IGhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKFxuICAgICAgbmV3IEJsb2IoW2pzb25dLCB7XG4gICAgICAgIHR5cGU6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnN0IGVsID0gT2JqZWN0LmFzc2lnbihkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYVwiKSwge1xuICAgICAgZG93bmxvYWQ6IFwic2t1cy5qc29uXCIsXG4gICAgICBocmVmLFxuICAgIH0pO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWwpO1xuICAgIGVsLmNsaWNrKCk7XG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlbCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRTa3VMaXN0KG51bWJlcjogbnVtYmVyKSB7XG4gICAgYXdhaXQgdGhpcy5mZXRjaFByZWxvYWREYXRhKGBzdG9yZS9saXN0LyR7bnVtYmVyfWApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkU2t1RGV0YWlscyhza3U6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuZmV0Y2hQcmVsb2FkRGF0YShgc3RvcmUvZGV0YWlscy9fL3NrdS8ke3NrdX1gKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFNrdURhdGEoZGF0YTogUHJvdG9EYXRhLCBwcmljaW5nOiBQcm90b0RhdGEpOiBTa3Uge1xuICAgIGNvbnN0IHR5cGVJZCA9IGRhdGFbNl07XG5cbiAgICBjb25zb2xlLmxvZyh7IHByaWNpbmcgfSk7XG4gICAgLy8gcHJpY2luZyBzaG91bGQgaW5jbHVkZSBub3JtYWwgcHJpY2UsIHBybyBwcmljZSxcbiAgICAvLyBjdXJyZW50IHNhbGUgcHJpY2VzIGZvciBlYWNoLCB0aGUgc3RhcnQgYW5kIGVuZCBkYXRlcyBvZiBlYWNoIHNhbGVcblxuICAgIGxldCBza3U7XG4gICAgaWYgKHR5cGVJZCA9PT0gMSkge1xuICAgICAgc2t1ID0gbmV3IEdhbWUoZGF0YVs0XSwgZGF0YVswXSwgXCJnYW1lXCIsIGRhdGFbMV0pO1xuICAgIH0gZWxzZSBpZiAodHlwZUlkID09PSAyKSB7XG4gICAgICBza3UgPSBuZXcgQWRkT24oZGF0YVs0XSwgZGF0YVswXSwgXCJhZGRvblwiLCBkYXRhWzFdKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVJZCA9PT0gMykge1xuICAgICAgc2t1ID0gbmV3IEJ1bmRsZShcbiAgICAgICAgZGF0YVs0XSxcbiAgICAgICAgZGF0YVswXSxcbiAgICAgICAgXCJidW5kbGVcIixcbiAgICAgICAgZGF0YVsxXSxcbiAgICAgICAgZGF0YVsxNF1bMF0ubWFwKCh4KSA9PiB4WzBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVJZCA9PT0gNSkge1xuICAgICAgc2t1ID0gbmV3IFN1YnNjcmlwdGlvbihcbiAgICAgICAgZGF0YVs0XSxcbiAgICAgICAgZGF0YVswXSxcbiAgICAgICAgXCJzdWJzY3JpcHRpb25cIixcbiAgICAgICAgZGF0YVsxXSxcbiAgICAgICAgZGF0YVsxNF1bMF0ubWFwKCh4KSA9PiB4WzBdKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgdW5leHBlY3RlZCBza3UgdHlwZSBpZCAke0pTT04uc3RyaW5naWZ5KHR5cGVJZCwgbnVsbCwgNCl9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5sb2FkU2t1KHNrdSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRTa3Uoc2t1OiBTa3UpOiBTa3Uge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5za3VzW3NrdS5za3VdO1xuICAgIGlmIChleGlzdGluZykge1xuICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KGV4aXN0aW5nKSAhPT0gSlNPTi5zdHJpbmdpZnkoc2t1KSkge1xuICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihgc2t1cyBoYWQgc2FtZSBza3UgYnV0IGRpZmZlcmVudCB2YWx1ZXNgKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXhpc3RpbmcsIHNrdSk7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNrdXNbc2t1LnNrdV0gPSBza3U7XG4gICAgICByZXR1cm4gc2t1O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZldGNoUHJlbG9hZERhdGEocGF0aDogc3RyaW5nKSB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+XG4gICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIE1hdGgucmFuZG9tKCkgKiAzXzAwMCArIDJfMDAwKVxuICAgICk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcImh0dHBzOi8vc3RhZGlhLmdvb2dsZS5jb20vXCIgKyBwYXRoKTtcbiAgICBjb25zdCBodG1sID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgIGNvbnN0IGRvY3VtZW50ID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhodG1sLCBcInRleHQvaHRtbFwiKTtcbiAgICBjb25zdCBzY3JpcHRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5zY3JpcHRzKTtcbiAgICBjb25zdCBjb250ZW50cyA9IHNjcmlwdHMubWFwKChzKSA9PiBzLnRleHRDb250ZW50LnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pO1xuXG4gICAgY29uc3QgZGF0YVNlcnZpY2VSZXF1ZXN0c1BhdHRlcm4gPSAvXnZhciAqQUZfaW5pdERhdGFLZXlzW15dKj92YXIgKkFGX2RhdGFTZXJ2aWNlUmVxdWVzdHMgKj0gKih7W15dKn0pOyAqP3ZhciAvO1xuXG4gICAgY29uc3QgZGF0YVNlcnZpY2VSZXF1ZXN0cyA9IGNvbnRlbnRzXG4gICAgICAubWFwKChzKSA9PiBzLm1hdGNoKGRhdGFTZXJ2aWNlUmVxdWVzdHNQYXR0ZXJuKSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgIC5tYXAoKG1hdGNoZXMpID0+XG4gICAgICAgIEpTT04ucGFyc2UoXG4gICAgICAgICAgbWF0Y2hlc1sxXVxuICAgICAgICAgICAgLnJlcGxhY2UoL3tpZDovZywgJ3tcImlkXCI6JylcbiAgICAgICAgICAgIC5yZXBsYWNlKC8scmVxdWVzdDovZywgJyxcInJlcXVlc3RcIjonKVxuICAgICAgICAgICAgLnJlcGxhY2UoLycvZywgJ1wiJylcbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgLm1hcCgocmVxdWVzdHMpID0+XG4gICAgICAgIE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgICAgICBPYmplY3QuZW50cmllcyhyZXF1ZXN0cykubWFwKChba2V5LCB2YWx1ZV06IGFueSkgPT4gW2tleSwgdmFsdWVdKVxuICAgICAgICApXG4gICAgICApWzBdO1xuXG4gICAgY29uc3QgZGF0YUNhbGxiYWNrUGF0dGVybiA9IC9eICpBRl9pbml0RGF0YUNhbGxiYWNrICpcXCggKnsgKmtleSAqOiAqJ2RzOihbMC05XSs/KScgKixbXl0qP2RhdGE6ICpmdW5jdGlvbiAqXFwoICpcXCl7ICpyZXR1cm4gKihbXl0qKVxccyp9XFxzKn1cXHMqXFwpXFxzKjs/XFxzKiQvO1xuICAgIGNvbnN0IGRhdGFTZXJ2aWNlTG9hZHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IG1hdGNoZXMgb2YgY29udGVudHNcbiAgICAgIC5tYXAoKHMpID0+IHMubWF0Y2goZGF0YUNhbGxiYWNrUGF0dGVybikpXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pKSB7XG4gICAgICBkYXRhU2VydmljZUxvYWRzW21hdGNoZXNbMV1dID0gSlNPTi5wYXJzZShtYXRjaGVzWzJdKTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRhU2VydmljZVJwY1ByZWZpeGVzID0gT2JqZWN0LnZhbHVlcyhkYXRhU2VydmljZVJlcXVlc3RzKS5tYXAoXG4gICAgICAoeDogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IHBpZWNlcyA9IFt4LmlkLCAuLi54LnJlcXVlc3RdO1xuICAgICAgICBjb25zdCBhbGlhc2VzID0gW107XG4gICAgICAgIGFsaWFzZXMucHVzaChcbiAgICAgICAgICBgJHtwaWVjZXNbMF19XyR7cGllY2VzLmZpbHRlcigoeCkgPT4geCAhPSBudWxsKS5sZW5ndGggLSAxfXMke1xuICAgICAgICAgICAgcGllY2VzLmZpbHRlcihCb29sZWFuKS5sZW5ndGggLSAxXG4gICAgICAgICAgfXQke3BpZWNlcy5sZW5ndGggLSAxfWFgXG4gICAgICAgICk7XG4gICAgICAgIHdoaWxlIChwaWVjZXMubGVuZ3RoKSB7XG4gICAgICAgICAgYWxpYXNlcy5wdXNoKHBpZWNlcy5qb2luKFwiX1wiKSk7XG4gICAgICAgICAgcGllY2VzLnBvcCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhbGlhc2VzO1xuICAgICAgfVxuICAgICk7XG5cbiAgICBjb25zdCBwcmVsb2FkID0gT2JqZWN0LnZhbHVlcyhkYXRhU2VydmljZUxvYWRzKTtcbiAgICBjb25zdCBycGMgPSB7fTtcbiAgICBjb25zdCBsb2FkZWQgPSB7fTtcblxuICAgIGNvbnN0IGxvYWRlcnMgPSB7XG4gICAgICBXd0QzcmI6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3Qgc2t1cyA9IGRhdGFbMl0ubWFwKChwOiBhbnkpID0+IHRoaXMubG9hZFNrdURhdGEocFs5XSkpO1xuICAgICAgICByZXR1cm4geyBza3VzIH07XG4gICAgICB9LFxuXG4gICAgICBGV2hRVl8yNHI6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3QgZ2FtZURhdGEgPSBkYXRhWzE4XT8uWzBdPy5bOV07XG4gICAgICAgIGNvbnN0IGdhbWVQcmljaW5nRGF0YSA9IGRhdGFbMThdPy5bMF0/LlsxNV0/LlswXTtcbiAgICAgICAgY29uc3QgZ2FtZSA9IGdhbWVEYXRhICYmIHRoaXMubG9hZFNrdURhdGEoZ2FtZURhdGEsIGdhbWVQcmljaW5nRGF0YSk7XG5cbiAgICAgICAgY29uc3QgYWRkb25zID0gKGRhdGFbMTldIGFzIGFueSk/Lm1hcCgoeDogYW55KSA9PlxuICAgICAgICAgIHRoaXMubG9hZFNrdURhdGEoeFs5XSlcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBza3VEYXRhID0gZGF0YVsxNl07XG4gICAgICAgIGNvbnN0IHNrdVByaWNpbmdEYXRhID0gZGF0YVsyMV0/LlswXTtcbiAgICAgICAgY29uc3Qgc2t1ID0gc2t1RGF0YSAmJiB0aGlzLmxvYWRTa3VEYXRhKHNrdURhdGEsIHNrdVByaWNpbmdEYXRhKTtcblxuICAgICAgICByZXR1cm4geyBza3UsIGdhbWUsIGFkZG9ucyB9O1xuICAgICAgfSxcblxuICAgICAgU1ljc1RkOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbkRhdGFzID0gZGF0YVsyXT8ubWFwKCh4KSA9PiB4WzldKSA/PyBbXTtcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9ucyA9IHN1YnNjcmlwdGlvbkRhdGFzLm1hcCgocykgPT4gdGhpcy5sb2FkU2t1RGF0YShzKSk7XG4gICAgICAgIGlmIChzdWJzY3JpcHRpb25zPy5sZW5ndGgpIHJldHVybiB7IHN1YnNjcmlwdGlvbnMgfTtcbiAgICAgICAgZWxzZSByZXR1cm4ge307XG4gICAgICB9LFxuXG4gICAgICBaQW03VzogKGRhdGE6IFByb3RvRGF0YSkgPT4ge1xuICAgICAgICBjb25zdCBidW5kbGVzID0gZGF0YVsxXS5tYXAoKHgpID0+IHRoaXMubG9hZFNrdURhdGEoeFs5XSkpO1xuICAgICAgICByZXR1cm4geyBidW5kbGVzIH07XG4gICAgICB9LFxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IFtpLCBkYXRhXSBvZiBPYmplY3QuZW50cmllcyhwcmVsb2FkKSkge1xuICAgICAgZm9yIChjb25zdCBwcmVmaXggb2YgZGF0YVNlcnZpY2VScGNQcmVmaXhlc1tpXSkge1xuICAgICAgICBmb3IgKGNvbnN0IHN1ZmZpeCBvZiBbXCJcIiwgXCJfXCIgKyBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGggKyBcInJcIl0pIHtcbiAgICAgICAgICBycGNbcHJlZml4ICsgc3VmZml4XSA9IGRhdGE7XG4gICAgICAgICAgY29uc3QgbG9hZGVyID0gbG9hZGVyc1twcmVmaXggKyBzdWZmaXhdO1xuICAgICAgICAgIGlmIChsb2FkZXIpIHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24obG9hZGVkLCBsb2FkZXIoZGF0YSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKFxuICAgICAgT2JqZWN0LmNyZWF0ZSh7XG4gICAgICAgIHByZWxvYWQsXG4gICAgICAgIHJwYyxcbiAgICAgIH0pLFxuICAgICAgbG9hZGVkXG4gICAgKTtcblxuICAgIGNvbnNvbGUuZGVidWcocGF0aCwgZGF0YSk7XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxufVxuXG5jbGFzcyBDb21tb25Ta3Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICByZWFkb25seSBhcHA6IHN0cmluZyxcbiAgICByZWFkb25seSBza3U6IHN0cmluZyxcbiAgICByZWFkb25seSB0eXBlOiBcImdhbWVcIiB8IFwiYWRkb25cIiB8IFwiYnVuZGxlXCIgfCBcInN1YnNjcmlwdGlvblwiLFxuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZ1xuICApIHt9XG5cbiAgcHVibGljIGtleSgpIHtcbiAgICByZXR1cm4gYCR7XG4gICAgICB7IGdhbWU6IFwiZ1wiLCBhZGRvbjogXCJvXCIsIGJ1bmRsZTogXCJ4XCIsIHN1YnNjcmlwdGlvbjogXCJhXCIgfVt0aGlzLnR5cGVdID8/XG4gICAgICB0aGlzLnR5cGVcbiAgICB9JHt0aGlzLmFwcC5zbGljZSgwLCA2KX0ke3RoaXMuc2t1LnNsaWNlKDAsIDQpfSR7dGhpcy5uYW1lLnNsaWNlKFxuICAgICAgTWF0aC5tYXgoMCwgMCB8ICgodGhpcy5uYW1lLmxlbmd0aCAtIDIwKSAvIDIpKSxcbiAgICAgIDIwXG4gICAgKX0ke3RoaXMuc2t1LnNsaWNlKDQpfWBcbiAgICAgIC50b0xvd2VyQ2FzZSgpXG4gICAgICAucmVwbGFjZSgvW15hLXowLTldKy9nLCBcIlwiKVxuICAgICAgLnNsaWNlKDAsIDMyKTtcbiAgfVxufVxuXG5jbGFzcyBHYW1lIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiZ2FtZVwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZ1xuICApIHtcbiAgICBzdXBlcihhcHAsIHNrdSwgdHlwZSwgbmFtZSk7XG4gIH1cbn1cblxuY2xhc3MgQWRkT24gZXh0ZW5kcyBDb21tb25Ta3Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IHN0cmluZyxcbiAgICBza3U6IHN0cmluZyxcbiAgICByZWFkb25seSB0eXBlID0gXCJhZGRvblwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZ1xuICApIHtcbiAgICBzdXBlcihhcHAsIHNrdSwgdHlwZSwgbmFtZSk7XG4gIH1cbn1cblxuY2xhc3MgQnVuZGxlIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiYnVuZGxlXCIgYXMgY29uc3QsXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNrdXM6IEFycmF5PHN0cmluZz5cbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUpO1xuICB9XG59XG5cbmNsYXNzIFN1YnNjcmlwdGlvbiBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcInN1YnNjcmlwdGlvblwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBza3VzOiBBcnJheTxzdHJpbmc+XG4gICkge1xuICAgIHN1cGVyKGFwcCwgc2t1LCB0eXBlLCBuYW1lKTtcbiAgfVxufVxuIl19
