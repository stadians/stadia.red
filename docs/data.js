import * as records from "./records.js";
export class DataStore {
  constructor() {
    // Update to clear existing data when making incompatible schema changes.
    this.schema = 20200205;
    this.skusById = new Map();
  }
  static async open() {
    const data = new DataStore();
    await data.load();
    return data;
  }
  async migrate() {
    const existingSchema = (await browser.storage.local.get("schema")).schema;
    if (this.schema !== existingSchema) {
      console.info(
        `Resetting extension storage (data schema was ${existingSchema} but we need ${this.schema}).`
      );
      await browser.storage.local.clear();
      await browser.storage.local.set({ schema: this.schema });
    }
  }
  async load() {
    await this.migrate();
    const { skusByLocalKey } = await browser.storage.local.get([
      "skusByLocalKey",
    ]);
    console.debug("i'd like to load", skusByLocalKey);
  }
  async save() {
    await this.migrate();
    await browser.storage.local.set({
      skusByLocalKey: records.sorted(
        Object.fromEntries(this.skusByLocalKey.entries())
      ),
    });
  }
  values() {
    return this.skusById.values();
  }
  get(id) {
    return this.skusById.get(id);
  }
  upsert(sku) {
    const existing = this.skusById.get(sku.sku);
    if (existing === undefined) {
      this.skusById.set(sku.sku, sku);
      console.info("SKU added", sku);
      return sku;
    }
    if (existing !== sku) {
      if (JSON.stringify(existing) !== JSON.stringify(sku)) {
        const previous = { ...existing };
        console.info(
          "SKU updated, adding",
          sku,
          "to",
          previous,
          "producing",
          existing
        );
        Object.assign(existing, sku);
      }
    }
    return existing;
  }
  if(existing) {
    const existingJson = JSON.stringify(existing);
    const newJson = JSON.stringify(sku);
    if (existingJson !== newJson) {
      console.warn(`skus had same ids but different properties.`);
      Object.assign(existing, sku);
    }
    return existing;
  }
}
{
  this.skus[sku.sku] = sku;
  return sku;
}
export const localKey = (sku) => {
  const length = 32;
  const maxNameLength = 23;
  const typeTag =
    { game: "g", addon: "o", bundle: "x", subscription: "c" }[sku.type] ??
    `?${sku.type}?`;
  const idsPrefix = sku.app.slice(0, 6) + sku.sku.slice(0, 2);
  const idsRest = sku.app.slice(6) + sku.sku.slice(2);
  let name = (sku.name + sku.internalSlug)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "");
  if (name.length > maxNameLength) {
    const letterCounts = {};
    for (const letter of name) {
      letterCounts[letter] = (letterCounts[letter] || 0) + 1;
    }
    while (name.length > maxNameLength) {
      const mostFrequentCount = Math.max(...Object.values(letterCounts));
      const mostFrequent = Object.entries(letterCounts)
        .filter(([_letter, count]) => count == mostFrequentCount)
        .map(([letter, _count]) => letter);
      for (let i = name.length - 1; i >= 0; i -= 1) {
        const letter = name[i];
        if (mostFrequent.includes(letter)) {
          name = name.slice(0, i) + name.slice(i + 1);
          letterCounts[letter] -= 1;
          break;
        }
      }
    }
  }
  return (typeTag + idsPrefix + name + idsRest).slice(0, length);
};
export class CommonSku {
  constructor(app, sku, type, name, internalSlug, description) {
    this.app = app;
    this.sku = sku;
    this.type = type;
    this.name = name;
    this.internalSlug = internalSlug;
    this.description = description;
    this.proPriceCents = null;
    this.proSalePriceCents = null;
    this.basePriceCents = null;
    this.baseSalePriceCents = null;
    this.localKey = localKey(this);
  }
}
export class Game extends CommonSku {
  constructor(app, sku, type = "game", name, internalSlug, description) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
  }
}
export class AddOn extends CommonSku {
  constructor(app, sku, type = "addon", name, internalSlug, description) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
  }
}
export class Bundle extends CommonSku {
  constructor(
    app,
    sku,
    type = "bundle",
    name,
    internalSlug,
    description,
    skus
  ) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
    this.skus = skus;
  }
}
export class Subscription extends CommonSku {
  constructor(
    app,
    sku,
    type = "subscription",
    name,
    internalSlug,
    description,
    skus
  ) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
    this.skus = skus;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsiZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGNBQWMsQ0FBQztBQUl4QyxNQUFNLE9BQU8sU0FBUztJQU1wQjtRQUxBLHlFQUF5RTtRQUNoRSxXQUFNLEdBQUcsUUFBVSxDQUFDO1FBRXJCLGFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQztJQUV2QixDQUFDO0lBRWpCLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSTtRQUN0QixNQUFNLElBQUksR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQzdCLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2xCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLEtBQUssQ0FBQyxPQUFPO1FBQ25CLE1BQU0sY0FBYyxHQUFHLENBQUMsTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDMUUsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLGNBQWMsRUFBRTtZQUNsQyxPQUFPLENBQUMsSUFBSSxDQUNWLGdEQUFnRCxjQUFjLGdCQUFnQixJQUFJLENBQUMsTUFBTSxJQUFJLENBQzlGLENBQUM7WUFDRixNQUFNLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3BDLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1NBQzFEO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJO1FBQ2YsTUFBTSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDckIsTUFBTSxFQUFFLGNBQWMsRUFBRSxHQUFHLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFL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WUFBYSxTQUFRLFNBQVM7SUFDekMsWUFDRSxHQUFXLEVBQ1gsR0FBVyxFQUNGLE9BQU8sY0FBdUIsRUFDdkMsSUFBWSxFQUNILFlBQW9CLEVBQ3BCLFdBQW1CLEVBQ25CLElBQW1CO1FBRTVCLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBTjlDLFNBQUksR0FBSixJQUFJLENBQTBCO1FBRTlCLGlCQUFZLEdBQVosWUFBWSxDQUFRO1FBQ3BCLGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQ25CLFNBQUksR0FBSixJQUFJLENBQWU7SUFHOUIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcmVjb3JkcyBmcm9tIFwiLi9yZWNvcmRzLmpzXCI7XG5cbmV4cG9ydCB0eXBlIFNrdSA9IEdhbWUgfCBBZGRPbiB8IEJ1bmRsZSB8IFN1YnNjcmlwdGlvbjtcblxuZXhwb3J0IGNsYXNzIERhdGFTdG9yZSB7XG4gIC8vIFVwZGF0ZSB0byBjbGVhciBleGlzdGluZyBkYXRhIHdoZW4gbWFraW5nIGluY29tcGF0aWJsZSBzY2hlbWEgY2hhbmdlcy5cbiAgcmVhZG9ubHkgc2NoZW1hID0gMjBfMjAwMl8wNTtcblxuICBwcml2YXRlIHNrdXNCeUlkID0gbmV3IE1hcDxTa3VbJ3NrdSddLCBTa3U+KCk7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHt9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBvcGVuKCkge1xuICAgIGNvbnN0IGRhdGEgPSBuZXcgRGF0YVN0b3JlKCk7XG4gICAgYXdhaXQgZGF0YS5sb2FkKCk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG1pZ3JhdGUoKSB7XG4gICAgY29uc3QgZXhpc3RpbmdTY2hlbWEgPSAoYXdhaXQgYnJvd3Nlci5zdG9yYWdlLmxvY2FsLmdldChcInNjaGVtYVwiKSkuc2NoZW1hO1xuICAgIGlmICh0aGlzLnNjaGVtYSAhPT0gZXhpc3RpbmdTY2hlbWEpIHtcbiAgICAgIGNvbnNvbGUuaW5mbyhcbiAgICAgICAgYFJlc2V0dGluZyBleHRlbnNpb24gc3RvcmFnZSAoZGF0YSBzY2hlbWEgd2FzICR7ZXhpc3RpbmdTY2hlbWF9IGJ1dCB3ZSBuZWVkICR7dGhpcy5zY2hlbWF9KS5gLFxuICAgICAgKTtcbiAgICAgIGF3YWl0IGJyb3dzZXIuc3RvcmFnZS5sb2NhbC5jbGVhcigpO1xuICAgICAgYXdhaXQgYnJvd3Nlci5zdG9yYWdlLmxvY2FsLnNldCh7IHNjaGVtYTogdGhpcy5zY2hlbWEgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGxvYWQoKSB7XG4gICAgYXdhaXQgdGhpcy5taWdyYXRlKCk7XG4gICAgY29uc3QgeyBza3VzQnlMb2NhbEtleSB9ID0gYXdhaXQgYnJvd3Nlci5zdG9yYWdlLmxvY2FsLmdldChbXG4gICAgICBcInNrdXNCeUxvY2FsS2V5XCIsXG4gICAgXSk7XG4gICAgY29uc29sZS5kZWJ1ZyhcImknZCBsaWtlIHRvIGxvYWRcIiwgc2t1c0J5TG9jYWxLZXkpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNhdmUoKSB7XG4gICAgYXdhaXQgdGhpcy5taWdyYXRlKCk7XG4gICAgYXdhaXQgYnJvd3Nlci5zdG9yYWdlLmxvY2FsLnNldCh7XG4gICAgICBza3VzQnlMb2NhbEtleTogcmVjb3Jkcy5zb3J0ZWQoXG4gICAgICAgIE9iamVjdC5mcm9tRW50cmllcyh0aGlzLnNrdXNCeUxvY2FsS2V5LmVudHJpZXMoKSksXG4gICAgICApLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHZhbHVlcygpOiBJdGVyYWJsZTxTa3U+IHtcbiAgICByZXR1cm4gdGhpcy5za3VzQnlJZC52YWx1ZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQoaWQ6IHN0cmluZyk6IFNrdSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuc2t1c0J5SWQuZ2V0KGlkKTtcbiAgfVxuXG4gIHB1YmxpYyB1cHNlcnQoc2t1OiBTa3UpOiBTa3Uge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5za3VzQnlJZC5nZXQoc2t1LnNrdSk7XG4gICAgaWYgKGV4aXN0aW5nID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuc2t1c0J5SWQuc2V0KHNrdS5za3UsIHNrdSk7XG4gICAgICBjb25zb2xlLmluZm8oXCJTS1UgYWRkZWRcIiwgc2t1KTtcbiAgICAgIHJldHVybiBza3U7XG4gICAgfVxuICAgIFxuICAgIGlmIChleGlzdGluZyAhPT0gc2t1KSB7XG4gICAgICBpZiAoSlNPTi5zdHJpbmdpZnkoZXhpc3RpbmcpICE9PSBKU09OLnN0cmluZ2lmeShza3UpKSB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzID0gey4uLmV4aXN0aW5nfTtcbiAgICAgICAgY29uc29sZS5pbmZvKFwiU0tVIHVwZGF0ZWQsIGFkZGluZ1wiLCBza3UsIFwidG9cIiwgcHJldmlvdXMsIFwicHJvZHVjaW5nXCIsIGV4aXN0aW5nKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihleGlzdGluZywgc2t1KTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGV4aXN0aW5nO1xuICB9XG5cbiAgICBcblxuICAgIGlmIChleGlzdGluZykge1xuICAgICAgY29uc3QgZXhpc3RpbmdKc29uID0gSlNPTi5zdHJpbmdpZnkoZXhpc3RpbmcpO1xuICAgICAgY29uc3QgbmV3SnNvbiA9IEpTT04uc3RyaW5naWZ5KHNrdSk7XG4gICAgICBpZiAoZXhpc3RpbmdKc29uICE9PSBuZXdKc29uKSB7XG4gICAgICAgIGNvbnNvbGUud2Fybihgc2t1cyBoYWQgc2FtZSBpZHMgYnV0IGRpZmZlcmVudCBwcm9wZXJ0aWVzLmApO1xuICAgICAgICBPYmplY3QuYXNzaWduKGV4aXN0aW5nLCBza3UpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNrdXNbc2t1LnNrdV0gPSBza3U7XG4gICAgICByZXR1cm4gc2t1O1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY29uc3QgbG9jYWxLZXkgPSAoc2t1OiBTa3UgfCBDb21tb25Ta3UpID0+IHtcbiAgY29uc3QgbGVuZ3RoID0gMzI7XG4gIGNvbnN0IG1heE5hbWVMZW5ndGggPSAyMztcbiAgY29uc3QgdHlwZVRhZyA9XG4gICAgKHsgZ2FtZTogXCJnXCIsIGFkZG9uOiBcIm9cIiwgYnVuZGxlOiBcInhcIiwgc3Vic2NyaXB0aW9uOiBcImNcIiB9IGFzIGFueSlbXG4gICAgICBza3UudHlwZVxuICAgIF0gPz8gYD8ke3NrdS50eXBlfT9gO1xuICBjb25zdCBpZHNQcmVmaXggPSBza3UuYXBwLnNsaWNlKDAsIDYpICsgc2t1LnNrdS5zbGljZSgwLCAyKTtcbiAgY29uc3QgaWRzUmVzdCA9IHNrdS5hcHAuc2xpY2UoNikgKyBza3Uuc2t1LnNsaWNlKDIpO1xuXG4gIGxldCBuYW1lID0gKHNrdS5uYW1lICsgc2t1LmludGVybmFsU2x1ZylcbiAgICAudG9Mb3dlckNhc2UoKVxuICAgIC5yZXBsYWNlKC9bXmEtejAtOV0rL2csIFwiXCIpO1xuXG4gIGlmIChuYW1lLmxlbmd0aCA+IG1heE5hbWVMZW5ndGgpIHtcbiAgICBjb25zdCBsZXR0ZXJDb3VudHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGxldHRlciBvZiBuYW1lKSB7XG4gICAgICBsZXR0ZXJDb3VudHNbbGV0dGVyXSA9IChsZXR0ZXJDb3VudHNbbGV0dGVyXSB8fCAwKSArIDE7XG4gICAgfVxuICAgIHdoaWxlIChuYW1lLmxlbmd0aCA+IG1heE5hbWVMZW5ndGgpIHtcbiAgICAgIGNvbnN0IG1vc3RGcmVxdWVudENvdW50ID0gTWF0aC5tYXgoLi4uT2JqZWN0LnZhbHVlcyhsZXR0ZXJDb3VudHMpKTtcbiAgICAgIGNvbnN0IG1vc3RGcmVxdWVudCA9IE9iamVjdC5lbnRyaWVzKGxldHRlckNvdW50cylcbiAgICAgICAgLmZpbHRlcigoW19sZXR0ZXIsIGNvdW50XSkgPT4gY291bnQgPT0gbW9zdEZyZXF1ZW50Q291bnQpXG4gICAgICAgIC5tYXAoKFtsZXR0ZXIsIF9jb3VudF0pID0+IGxldHRlcik7XG4gICAgICBmb3IgKGxldCBpID0gbmFtZS5sZW5ndGggLSAxOyBpID49IDA7IGkgLT0gMSkge1xuICAgICAgICBjb25zdCBsZXR0ZXIgPSBuYW1lW2ldO1xuICAgICAgICBpZiAobW9zdEZyZXF1ZW50LmluY2x1ZGVzKGxldHRlcikpIHtcbiAgICAgICAgICBuYW1lID0gbmFtZS5zbGljZSgwLCBpKSArIG5hbWUuc2xpY2UoaSArIDEpO1xuICAgICAgICAgIGxldHRlckNvdW50c1tsZXR0ZXJdIC09IDE7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gKHR5cGVUYWcgKyBpZHNQcmVmaXggKyBuYW1lICsgaWRzUmVzdCkuc2xpY2UoMCwgbGVuZ3RoKTtcbn07XG5cbmV4cG9ydCBjbGFzcyBDb21tb25Ta3Uge1xuICByZWFkb25seSBwcm9QcmljZUNlbnRzOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgcmVhZG9ubHkgcHJvU2FsZVByaWNlQ2VudHM6IG51bWJlciB8IG51bGwgPSBudWxsO1xuICByZWFkb25seSBiYXNlUHJpY2VDZW50czogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIHJlYWRvbmx5IGJhc2VTYWxlUHJpY2VDZW50czogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgYXBwOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZTogXCJnYW1lXCIgfCBcImFkZG9uXCIgfCBcImJ1bmRsZVwiIHwgXCJzdWJzY3JpcHRpb25cIixcbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgaW50ZXJuYWxTbHVnOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgZGVzY3JpcHRpb246IHN0cmluZyxcbiAgKSB7XG4gICAgdGhpcy5sb2NhbEtleSA9IGxvY2FsS2V5KHRoaXMpO1xuICB9XG4gIHJlYWRvbmx5IGxvY2FsS2V5OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBHYW1lIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiZ2FtZVwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICApIHtcbiAgICBzdXBlcihhcHAsIHNrdSwgdHlwZSwgbmFtZSwgaW50ZXJuYWxTbHVnLCBkZXNjcmlwdGlvbik7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEFkZE9uIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiYWRkb25cIiBhcyBjb25zdCxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgaW50ZXJuYWxTbHVnOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgZGVzY3JpcHRpb246IHN0cmluZyxcbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUsIGludGVybmFsU2x1ZywgZGVzY3JpcHRpb24pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCdW5kbGUgZXh0ZW5kcyBDb21tb25Ta3Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IHN0cmluZyxcbiAgICBza3U6IHN0cmluZyxcbiAgICByZWFkb25seSB0eXBlID0gXCJidW5kbGVcIiBhcyBjb25zdCxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgaW50ZXJuYWxTbHVnOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgZGVzY3JpcHRpb246IHN0cmluZyxcbiAgICByZWFkb25seSBza3VzOiBBcnJheTxzdHJpbmc+LFxuICApIHtcbiAgICBzdXBlcihhcHAsIHNrdSwgdHlwZSwgbmFtZSwgaW50ZXJuYWxTbHVnLCBkZXNjcmlwdGlvbik7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN1YnNjcmlwdGlvbiBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcInN1YnNjcmlwdGlvblwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNrdXM6IEFycmF5PHN0cmluZz4sXG4gICkge1xuICAgIHN1cGVyKGFwcCwgc2t1LCB0eXBlLCBuYW1lLCBpbnRlcm5hbFNsdWcsIGRlc2NyaXB0aW9uKTtcbiAgfVxufVxuIl19
