import { records } from "./index.js";
export class DataStore {
  constructor() {
    // Update to clear existing data when making incompatible schema changes.
    this.schema = 20200205;
    this.skusById = new Map();
  }
  static async open() {
    const data = new DataStore();
    await data.load();
    return data;
  }
  async migrate() {
    const existingSchema = (await browser.storage.local.get("schema")).schema;
    if (this.schema !== existingSchema) {
      console.info(
        `Resetting extension storage (data schema was ${existingSchema} but we need ${this.schema}).`
      );
      await browser.storage.local.clear();
      await browser.storage.local.set({ schema: this.schema });
    }
  }
  async load() {
    await this.migrate();
    const { skusById } = await browser.storage.local.get(["skusById"]);
    console.debug("i'd like to load", skusById);
  }
  async save() {
    await this.migrate();
    await browser.storage.local.set({
      skusById: records.sorted(Object.fromEntries(this.skusById.entries())),
    });
  }
  values() {
    return this.skusById.values();
  }
  get(id) {
    return this.skusById.get(id);
  }
  upsert(sku) {
    const existing = this.skusById.get(sku.sku);
    if (existing === undefined) {
      this.skusById.set(sku.sku, sku);
      console.info("SKU added", sku);
      return sku;
    }
    if (existing !== sku) {
      if (JSON.stringify(existing) !== JSON.stringify(sku)) {
        const previous = { ...existing };
        console.info(
          "SKU updated, adding",
          sku,
          "to",
          previous,
          "producing",
          existing
        );
        Object.assign(existing, sku);
      }
    }
    return existing;
  }
}
export const localKey = (sku) => {
  const length = 32;
  const maxNameLength = 23;
  const typeTag =
    { game: "g", addon: "o", bundle: "x", subscription: "c" }[sku.type] ??
    `?${sku.type}?`;
  const idsPrefix = sku.app.slice(0, 6) + sku.sku.slice(0, 2);
  const idsRest = sku.app.slice(6) + sku.sku.slice(2);
  let name = (sku.name + sku.internalSlug)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "");
  if (name.length > maxNameLength) {
    const letterCounts = {};
    for (const letter of name) {
      letterCounts[letter] = (letterCounts[letter] || 0) + 1;
    }
    while (name.length > maxNameLength) {
      const mostFrequentCount = Math.max(...Object.values(letterCounts));
      const mostFrequent = Object.entries(letterCounts)
        .filter(([_letter, count]) => count == mostFrequentCount)
        .map(([letter, _count]) => letter);
      for (let i = name.length - 1; i >= 0; i -= 1) {
        const letter = name[i];
        if (mostFrequent.includes(letter)) {
          name = name.slice(0, i) + name.slice(i + 1);
          letterCounts[letter] -= 1;
          break;
        }
      }
    }
  }
  return (typeTag + idsPrefix + name + idsRest).slice(0, length);
};
export class CommonSku {
  constructor(app, sku, type, name, internalSlug, description) {
    this.app = app;
    this.sku = sku;
    this.type = type;
    this.name = name;
    this.internalSlug = internalSlug;
    this.description = description;
    this.proPriceCents = null;
    this.proSalePriceCents = null;
    this.basePriceCents = null;
    this.baseSalePriceCents = null;
    this.localKey = localKey(this);
  }
}
export class Game extends CommonSku {
  constructor(app, sku, type = "game", name, internalSlug, description) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
  }
}
export class AddOn extends CommonSku {
  constructor(app, sku, type = "addon", name, internalSlug, description) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
  }
}
export class Bundle extends CommonSku {
  constructor(
    app,
    sku,
    type = "bundle",
    name,
    internalSlug,
    description,
    skus
  ) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
    this.skus = skus;
  }
}
export class Subscription extends CommonSku {
  constructor(
    app,
    sku,
    type = "subscription",
    name,
    internalSlug,
    description,
    skus
  ) {
    super(app, sku, type, name, internalSlug, description);
    this.type = type;
    this.internalSlug = internalSlug;
    this.description = description;
    this.skus = skus;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsiZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBSXJDLE1BQU0sT0FBTyxTQUFTO0lBTXBCO1FBTEEseUVBQXlFO1FBQ2hFLFdBQU0sR0FBRyxRQUFVLENBQUM7UUFFckIsYUFBUSxHQUFHLElBQUksR0FBRyxFQUFtQixDQUFDO0lBRXZCLENBQUM7SUFFakIsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJO1FBQ3RCLE1BQU0sSUFBSSxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7UUFDN0IsTUFBTSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbEIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sS0FBSyxDQUFDLE9BQU87UUFDbkIsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFNLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUMxRSxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssY0FBYyxFQUFFO1lBQ2xDLE9BQU8sQ0FBQyxJQUFJLENBQ1YsZ0RBQWdELGNBQWMsZ0JBQWdCLElBQUksQ0FBQyxNQUFNLElBQUksQ0FDOUYsQ0FBQztZQUNGLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDcEMsTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7U0FDMUQ7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLElBQUk7UUFDZixNQUFNLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyQixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFD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QjtRQUU1QixLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztRQUw5QyxTQUFJLEdBQUosSUFBSSxDQUFtQjtRQUV2QixpQkFBWSxHQUFaLFlBQVksQ0FBUTtRQUNwQixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtJQUc5QixDQUFDO0NBQ0Y7QUFFRCxNQUFNLE9BQU8sTUFBTyxTQUFRLFNBQVM7SUFDbkMsWUFDRSxHQUFXLEVBQ1gsR0FBVyxFQUNGLE9BQU8sUUFBaUIsRUFDakMsSUFBWSxFQUNILFlBQW9CLEVBQ3BCLFdBQW1CLEVBQ25CLElBQW1CO1FBRTVCLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBTjlDLFNBQUksR0FBSixJQUFJLENBQW9CO1FBRXhCLGlCQUFZLEdBQVosWUFBWSxDQUFRO1FBQ3BCLGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQ25CLFNBQUksR0FBSixJQUFJLENBQWU7SUFHOUIsQ0FBQztDQUNGO0FBRUQsTUFBTSxPQUFPLFlBQWEsU0FBUSxTQUFTO0lBQ3pDLFlBQ0UsR0FBVyxFQUNYLEdBQVcsRUFDRixPQUFPLGNBQXVCLEVBQ3ZDLElBQVksRUFDSCxZQUFvQixFQUNwQixXQUFtQixFQUNuQixJQUFtQjtRQUU1QixLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztRQU45QyxTQUFJLEdBQUosSUFBSSxDQUEwQjtRQUU5QixpQkFBWSxHQUFaLFlBQVksQ0FBUTtRQUNwQixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUNuQixTQUFJLEdBQUosSUFBSSxDQUFlO0lBRzlCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlY29yZHMgfSBmcm9tIFwiLi9pbmRleC5qc1wiO1xuXG5leHBvcnQgdHlwZSBTa3UgPSBHYW1lIHwgQWRkT24gfCBCdW5kbGUgfCBTdWJzY3JpcHRpb247XG5cbmV4cG9ydCBjbGFzcyBEYXRhU3RvcmUge1xuICAvLyBVcGRhdGUgdG8gY2xlYXIgZXhpc3RpbmcgZGF0YSB3aGVuIG1ha2luZyBpbmNvbXBhdGlibGUgc2NoZW1hIGNoYW5nZXMuXG4gIHJlYWRvbmx5IHNjaGVtYSA9IDIwXzIwMDJfMDU7XG5cbiAgcHJpdmF0ZSBza3VzQnlJZCA9IG5ldyBNYXA8U2t1W1wic2t1XCJdLCBTa3U+KCk7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHt9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBvcGVuKCkge1xuICAgIGNvbnN0IGRhdGEgPSBuZXcgRGF0YVN0b3JlKCk7XG4gICAgYXdhaXQgZGF0YS5sb2FkKCk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG1pZ3JhdGUoKSB7XG4gICAgY29uc3QgZXhpc3RpbmdTY2hlbWEgPSAoYXdhaXQgYnJvd3Nlci5zdG9yYWdlLmxvY2FsLmdldChcInNjaGVtYVwiKSkuc2NoZW1hO1xuICAgIGlmICh0aGlzLnNjaGVtYSAhPT0gZXhpc3RpbmdTY2hlbWEpIHtcbiAgICAgIGNvbnNvbGUuaW5mbyhcbiAgICAgICAgYFJlc2V0dGluZyBleHRlbnNpb24gc3RvcmFnZSAoZGF0YSBzY2hlbWEgd2FzICR7ZXhpc3RpbmdTY2hlbWF9IGJ1dCB3ZSBuZWVkICR7dGhpcy5zY2hlbWF9KS5gXG4gICAgICApO1xuICAgICAgYXdhaXQgYnJvd3Nlci5zdG9yYWdlLmxvY2FsLmNsZWFyKCk7XG4gICAgICBhd2FpdCBicm93c2VyLnN0b3JhZ2UubG9jYWwuc2V0KHsgc2NoZW1hOiB0aGlzLnNjaGVtYSB9KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbG9hZCgpIHtcbiAgICBhd2FpdCB0aGlzLm1pZ3JhdGUoKTtcbiAgICBjb25zdCB7IHNrdXNCeUlkIH0gPSBhd2FpdCBicm93c2VyLnN0b3JhZ2UubG9jYWwuZ2V0KFtcInNrdXNCeUlkXCJdKTtcbiAgICBjb25zb2xlLmRlYnVnKFwiaSdkIGxpa2UgdG8gbG9hZFwiLCBza3VzQnlJZCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2F2ZSgpIHtcbiAgICBhd2FpdCB0aGlzLm1pZ3JhdGUoKTtcbiAgICBhd2FpdCBicm93c2VyLnN0b3JhZ2UubG9jYWwuc2V0KHtcbiAgICAgIHNrdXNCeUlkOiByZWNvcmRzLnNvcnRlZChPYmplY3QuZnJvbUVudHJpZXModGhpcy5za3VzQnlJZC5lbnRyaWVzKCkpKSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyB2YWx1ZXMoKTogSXRlcmFibGU8U2t1PiB7XG4gICAgcmV0dXJuIHRoaXMuc2t1c0J5SWQudmFsdWVzKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0KGlkOiBzdHJpbmcpOiBTa3UgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnNrdXNCeUlkLmdldChpZCk7XG4gIH1cblxuICBwdWJsaWMgdXBzZXJ0KHNrdTogU2t1KTogU2t1IHtcbiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuc2t1c0J5SWQuZ2V0KHNrdS5za3UpO1xuICAgIGlmIChleGlzdGluZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnNrdXNCeUlkLnNldChza3Uuc2t1LCBza3UpO1xuICAgICAgY29uc29sZS5pbmZvKFwiU0tVIGFkZGVkXCIsIHNrdSk7XG4gICAgICByZXR1cm4gc2t1O1xuICAgIH1cblxuICAgIGlmIChleGlzdGluZyAhPT0gc2t1KSB7XG4gICAgICBpZiAoSlNPTi5zdHJpbmdpZnkoZXhpc3RpbmcpICE9PSBKU09OLnN0cmluZ2lmeShza3UpKSB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzID0geyAuLi5leGlzdGluZyB9O1xuICAgICAgICBjb25zb2xlLmluZm8oXG4gICAgICAgICAgXCJTS1UgdXBkYXRlZCwgYWRkaW5nXCIsXG4gICAgICAgICAgc2t1LFxuICAgICAgICAgIFwidG9cIixcbiAgICAgICAgICBwcmV2aW91cyxcbiAgICAgICAgICBcInByb2R1Y2luZ1wiLFxuICAgICAgICAgIGV4aXN0aW5nXG4gICAgICAgICk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oZXhpc3RpbmcsIHNrdSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4aXN0aW5nO1xuICB9XG5cbiAgLy8gICBpZiAoZXhpc3RpbmcpIHtcbiAgLy8gICAgIGNvbnN0IGV4aXN0aW5nSnNvbiA9IEpTT04uc3RyaW5naWZ5KGV4aXN0aW5nKTtcbiAgLy8gICAgIGNvbnN0IG5ld0pzb24gPSBKU09OLnN0cmluZ2lmeShza3UpO1xuICAvLyAgICAgaWYgKGV4aXN0aW5nSnNvbiAhPT0gbmV3SnNvbikge1xuICAvLyAgICAgICBjb25zb2xlLndhcm4oYHNrdXMgaGFkIHNhbWUgaWRzIGJ1dCBkaWZmZXJlbnQgcHJvcGVydGllcy5gKTtcbiAgLy8gICAgICAgT2JqZWN0LmFzc2lnbihleGlzdGluZywgc2t1KTtcbiAgLy8gICAgIH1cbiAgLy8gICAgIHJldHVybiBleGlzdGluZztcbiAgLy8gICB9IGVsc2Uge1xuICAvLyAgICAgdGhpcy5za3VzW3NrdS5za3VdID0gc2t1O1xuICAvLyAgICAgcmV0dXJuIHNrdTtcbiAgLy8gICB9XG4gIC8vIH1cbn1cblxuZXhwb3J0IGNvbnN0IGxvY2FsS2V5ID0gKHNrdTogU2t1IHwgQ29tbW9uU2t1KSA9PiB7XG4gIGNvbnN0IGxlbmd0aCA9IDMyO1xuICBjb25zdCBtYXhOYW1lTGVuZ3RoID0gMjM7XG4gIGNvbnN0IHR5cGVUYWcgPVxuICAgICh7IGdhbWU6IFwiZ1wiLCBhZGRvbjogXCJvXCIsIGJ1bmRsZTogXCJ4XCIsIHN1YnNjcmlwdGlvbjogXCJjXCIgfSBhcyBhbnkpW1xuICAgICAgc2t1LnR5cGVcbiAgICBdID8/IGA/JHtza3UudHlwZX0/YDtcbiAgY29uc3QgaWRzUHJlZml4ID0gc2t1LmFwcC5zbGljZSgwLCA2KSArIHNrdS5za3Uuc2xpY2UoMCwgMik7XG4gIGNvbnN0IGlkc1Jlc3QgPSBza3UuYXBwLnNsaWNlKDYpICsgc2t1LnNrdS5zbGljZSgyKTtcblxuICBsZXQgbmFtZSA9IChza3UubmFtZSArIHNrdS5pbnRlcm5hbFNsdWcpXG4gICAgLnRvTG93ZXJDYXNlKClcbiAgICAucmVwbGFjZSgvW15hLXowLTldKy9nLCBcIlwiKTtcblxuICBpZiAobmFtZS5sZW5ndGggPiBtYXhOYW1lTGVuZ3RoKSB7XG4gICAgY29uc3QgbGV0dGVyQ291bnRzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG4gICAgZm9yIChjb25zdCBsZXR0ZXIgb2YgbmFtZSkge1xuICAgICAgbGV0dGVyQ291bnRzW2xldHRlcl0gPSAobGV0dGVyQ291bnRzW2xldHRlcl0gfHwgMCkgKyAxO1xuICAgIH1cbiAgICB3aGlsZSAobmFtZS5sZW5ndGggPiBtYXhOYW1lTGVuZ3RoKSB7XG4gICAgICBjb25zdCBtb3N0RnJlcXVlbnRDb3VudCA9IE1hdGgubWF4KC4uLk9iamVjdC52YWx1ZXMobGV0dGVyQ291bnRzKSk7XG4gICAgICBjb25zdCBtb3N0RnJlcXVlbnQgPSBPYmplY3QuZW50cmllcyhsZXR0ZXJDb3VudHMpXG4gICAgICAgIC5maWx0ZXIoKFtfbGV0dGVyLCBjb3VudF0pID0+IGNvdW50ID09IG1vc3RGcmVxdWVudENvdW50KVxuICAgICAgICAubWFwKChbbGV0dGVyLCBfY291bnRdKSA9PiBsZXR0ZXIpO1xuICAgICAgZm9yIChsZXQgaSA9IG5hbWUubGVuZ3RoIC0gMTsgaSA+PSAwOyBpIC09IDEpIHtcbiAgICAgICAgY29uc3QgbGV0dGVyID0gbmFtZVtpXTtcbiAgICAgICAgaWYgKG1vc3RGcmVxdWVudC5pbmNsdWRlcyhsZXR0ZXIpKSB7XG4gICAgICAgICAgbmFtZSA9IG5hbWUuc2xpY2UoMCwgaSkgKyBuYW1lLnNsaWNlKGkgKyAxKTtcbiAgICAgICAgICBsZXR0ZXJDb3VudHNbbGV0dGVyXSAtPSAxO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuICh0eXBlVGFnICsgaWRzUHJlZml4ICsgbmFtZSArIGlkc1Jlc3QpLnNsaWNlKDAsIGxlbmd0aCk7XG59O1xuXG5leHBvcnQgY2xhc3MgQ29tbW9uU2t1IHtcbiAgcmVhZG9ubHkgcHJvUHJpY2VDZW50czogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIHJlYWRvbmx5IHByb1NhbGVQcmljZUNlbnRzOiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgcmVhZG9ubHkgYmFzZVByaWNlQ2VudHM6IG51bWJlciB8IG51bGwgPSBudWxsO1xuICByZWFkb25seSBiYXNlU2FsZVByaWNlQ2VudHM6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IGFwcDogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGU6IFwiZ2FtZVwiIHwgXCJhZGRvblwiIHwgXCJidW5kbGVcIiB8IFwic3Vic2NyaXB0aW9uXCIsXG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGludGVybmFsU2x1Zzogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGRlc2NyaXB0aW9uOiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy5sb2NhbEtleSA9IGxvY2FsS2V5KHRoaXMpO1xuICB9XG4gIHJlYWRvbmx5IGxvY2FsS2V5OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBHYW1lIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiZ2FtZVwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nXG4gICkge1xuICAgIHN1cGVyKGFwcCwgc2t1LCB0eXBlLCBuYW1lLCBpbnRlcm5hbFNsdWcsIGRlc2NyaXB0aW9uKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQWRkT24gZXh0ZW5kcyBDb21tb25Ta3Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IHN0cmluZyxcbiAgICBza3U6IHN0cmluZyxcbiAgICByZWFkb25seSB0eXBlID0gXCJhZGRvblwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nXG4gICkge1xuICAgIHN1cGVyKGFwcCwgc2t1LCB0eXBlLCBuYW1lLCBpbnRlcm5hbFNsdWcsIGRlc2NyaXB0aW9uKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQnVuZGxlIGV4dGVuZHMgQ29tbW9uU2t1IHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBzdHJpbmcsXG4gICAgc2t1OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgdHlwZSA9IFwiYnVuZGxlXCIgYXMgY29uc3QsXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGludGVybmFsU2x1Zzogc3RyaW5nLFxuICAgIHJlYWRvbmx5IGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgc2t1czogQXJyYXk8c3RyaW5nPlxuICApIHtcbiAgICBzdXBlcihhcHAsIHNrdSwgdHlwZSwgbmFtZSwgaW50ZXJuYWxTbHVnLCBkZXNjcmlwdGlvbik7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN1YnNjcmlwdGlvbiBleHRlbmRzIENvbW1vblNrdSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogc3RyaW5nLFxuICAgIHNrdTogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHR5cGUgPSBcInN1YnNjcmlwdGlvblwiIGFzIGNvbnN0LFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICByZWFkb25seSBpbnRlcm5hbFNsdWc6IHN0cmluZyxcbiAgICByZWFkb25seSBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICAgIHJlYWRvbmx5IHNrdXM6IEFycmF5PHN0cmluZz5cbiAgKSB7XG4gICAgc3VwZXIoYXBwLCBza3UsIHR5cGUsIG5hbWUsIGludGVybmFsU2x1ZywgZGVzY3JpcHRpb24pO1xuICB9XG59XG4iXX0=
