import * as records from "./records.js";
import {
  AddOn,
  Bundle,
  DataStore,
  Game,
  Prices,
  Subscription,
} from "./data.js";
export const spider = async () => {
  const storage = await DataStore.open();
  const spider = new Spider();
  console.debug("starting spider", spider);
  const data = await spider.load();
  console.debug("completed spider", spider, data);
  await storage.save();
  spider.download();
};
class Spider {
  constructor(skus = {}, spidered = {}) {
    this.skus = skus;
    this.spidered = spidered;
    let start;
    const started = new Promise(resolve => (start = resolve));
    this.start = start;
    this.done = started
      .then(() => this.spider())
      .then(() => {
        Object.freeze(this.skus);
        for (const sku of Object.values(this.skus)) {
          Object.freeze(sku);
        }
      });
  }
  async load() {
    this.start();
    await this.done;
    return this.output();
  }
  async spider() {
    if (false) {
      await this.loadSkuDetails("59c8314ac82a456ba61d08988b15b550");
      await this.loadSkuDetails("b171fc78d4e1496d9536d585257a771e");
      await this.loadSkuDetails("4950959380034dcda0aecf98f675e11f");
      await this.loadSkuDetails("2e07db5d338d40cb9eac9deae4154f11");
      await this.loadSkuList(3);
      await this.loadSkuList(2001);
      await this.loadSkuList(45);
      await this.loadSkuList(6);
      throw "TODO: remove me";
    }
    await this.loadSkuList(3);
    while (Object.keys(this.skus).length > Object.keys(this.spidered).length) {
      for (const sku of Object.values(this.skus)) {
        if (this.spidered[sku.sku] !== true) {
          console.debug("spidering ", sku);
          await this.loadSkuDetails(sku.sku);
          this.spidered[sku.sku] = true;
        }
      }
    }
  }
  output() {
    return records.sorted(
      Object.fromEntries(
        Object.values(this.skus)
          .map(sku => records.sorted(sku))
          .map(sku => [sku.localKey, sku]),
      ),
    );
  }
  download() {
    const output = this.output();
    const json = JSON.stringify(output, null, 2);
    // XXX: this blob is leaked
    const href = URL.createObjectURL(
      new Blob([json], {
        type: "application/json",
      }),
    );
    const el = Object.assign(document.createElement("a"), {
      download: "skus.json",
      href,
    });
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async loadSkuList(number) {
    await this.fetchPreloadData(`store/list/${number}`);
  }
  async loadSkuDetails(sku) {
    await this.fetchPreloadData(`store/details/_/sku/${sku}`);
  }
  loadSkuData(data, priceData) {
    const app = data[4];
    const skuId = data[0];
    const name = data[1];
    const internalSlug = data[5];
    const description = data[9];
    const prices = priceData && Prices.fromProto(priceData);
    const typeId = data[6];
    console.log({ name, data, priceData, prices });
    let sku;
    if (typeId === 1) {
      sku = new Game(
        app,
        skuId,
        "game",
        name,
        internalSlug,
        description,
        prices,
      );
    } else if (typeId === 2) {
      sku = new AddOn(
        app,
        skuId,
        "addon",
        name,
        internalSlug,
        description,
        prices,
      );
    } else if (typeId === 3) {
      sku = new Bundle(
        app,
        skuId,
        "bundle",
        name,
        internalSlug,
        description,
        prices,
        data[14][0].map(x => x[0]),
      );
    } else if (typeId === 5) {
      sku = new Subscription(
        app,
        skuId,
        "subscription",
        name,
        internalSlug,
        description,
        prices,
        data[14][0].map(x => x[0]),
      );
    } else {
      throw new Error(
        `unexpected sku type id ${JSON.stringify(typeId, null, 4)}`,
      );
    }
    return this.loadSku(sku);
  }
  loadSku(sku) {
    const existing = this.skus[sku.sku];
    if (existing) {
      const existingJson = JSON.stringify(existing);
      const newJson = JSON.stringify(sku);
      if (existingJson !== newJson) {
        console.warn(`skus had same ids but different properties.`);
        Object.assign(existing, sku);
      }
      return existing;
    } else {
      this.skus[sku.sku] = sku;
      return sku;
    }
  }
  async fetchPreloadData(path) {
    await new Promise(resolve =>
      setTimeout(resolve, Math.random() * 1000 + 2000),
    );
    const response = await fetch("https://stadia.google.com/" + path, {
      headers: {
        "User-Agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36",
      },
    });
    const html = await response.text();
    const document = new DOMParser().parseFromString(html, "text/html");
    const scripts = Array.from(document.scripts);
    const contents = scripts.map(s => s.textContent?.trim()).filter(Boolean);
    const dataServiceRequestsPattern = /^var *AF_initDataKeys[^]*?var *AF_dataServiceRequests *= *({[^]*}); *?var /;
    const dataServiceRequests = contents
      .map(s => s.match(dataServiceRequestsPattern))
      .filter(Boolean)
      .map(matches =>
        JSON.parse(
          matches[1]
            .replace(/{id:/g, '{"id":')
            .replace(/,request:/g, ',"request":')
            .replace(/'/g, '"'),
        ),
      )
      .map(requests =>
        Object.fromEntries(
          Object.entries(requests).map(([key, value]) => [key, value]),
        ),
      )[0];
    const dataCallbackPattern = /^ *AF_initDataCallback *\( *{ *key *: *'ds:([0-9]+?)' *,[^]*?data: *function *\( *\){ *return *([^]*)\s*}\s*}\s*\)\s*;?\s*$/;
    const dataServiceLoads = [];
    for (const matches of contents
      .map(s => s.match(dataCallbackPattern))
      .filter(Boolean)) {
      dataServiceLoads[matches[1]] = JSON.parse(matches[2]);
    }
    6;
    const dataServiceRpcPrefixes = Object.values(dataServiceRequests).map(x => {
      const pieces = [x.id, ...x.request];
      const aliases = [];
      aliases.push(
        `${pieces[0]}_${pieces.filter(x => x != null).length - 1}s${
          pieces.filter(Boolean).length - 1
        }t${pieces.length - 1}a`,
      );
      while (pieces.length) {
        aliases.push(pieces.join("_"));
        pieces.pop();
      }
      return aliases;
    });
    const preload = Object.values(dataServiceLoads);
    const rpc = {};
    const loaded = {};
    const loaders = {
      WwD3rb: data => {
        const skus = data[2].map(p => this.loadSkuData(p[9], p[9][15]));
        return { skus };
      },
      FWhQV_24r: data => {
        const gameData = data[18]?.[0]?.[9];
        const gamePricingData = data[18]?.[0]?.[15]?.[0];
        const game = gameData && this.loadSkuData(gameData, gamePricingData);
        const addons = data[19]?.map(x => this.loadSkuData(x[9]));
        const skuData = data[16];
        const skuPricingData = data[21]?.[0];
        const sku = skuData && this.loadSkuData(skuData, skuPricingData);
        return { sku, game, addons };
      },
      SYcsTd: data => {
        const subscriptionDatas = data[2]?.map(x => x[9]) ?? [];
        const subscriptions = subscriptionDatas.map(s => this.loadSkuData(s));
        if (subscriptions?.length) return { subscriptions };
        else return {};
      },
      ZAm7W: data => {
        const bundles = data[1].map(x => this.loadSkuData(x[9]));
        return { bundles };
      },
    };
    for (const [i, data] of Object.entries(preload)) {
      for (const prefix of dataServiceRpcPrefixes[i]) {
        for (const suffix of ["", "_" + Object.keys(data).length + "r"]) {
          rpc[prefix + suffix] = data;
          const loader = loaders[prefix + suffix];
          if (loader) {
            Object.assign(loaded, loader(data));
          }
        }
      }
    }
    const data = Object.assign(
      Object.create({
        preload,
        rpc,
      }),
      loaded,
    );
    console.debug(path, data);
    return data;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BpZGVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJmb3JlZ3JvdW5kL3NwaWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGNBQWMsQ0FBQztBQUV4QyxPQUFPLEVBQ0wsS0FBSyxFQUNMLE1BQU0sRUFDTixTQUFTLEVBQ1QsSUFBSSxFQUNKLE1BQU0sRUFFTixZQUFZLEdBQ2IsTUFBTSxXQUFXLENBQUM7QUFJbkIsTUFBTSxDQUFDLE1BQU0sTUFBTSxHQUFHLEtBQUssSUFBSSxFQUFFO0lBQy9CLE1BQU0sT0FBTyxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3ZDLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7SUFDNUIsT0FBTyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN6QyxNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNqQyxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNoRCxNQUFNLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNyQixNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDcEIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxNQUFNO0lBR1YsWUFDbUIsT0FBZ0MsRUFBRSxFQUNsQyxXQUFxQyxFQUFFO1FBRHZDLFNBQUksR0FBSixJQUFJLENBQThCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQStCO1FBRXhELElBQUksS0FBaUIsQ0FBQztRQUN0QixNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUks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QUFFO1lBQy9DLEtBQUssTUFBTSxNQUFNLElBQUksc0JBQXNCLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzlDLEtBQUssTUFBTSxNQUFNLElBQUksQ0FBQyxFQUFFLEVBQUUsR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxFQUFFO29CQUMvRCxHQUFHLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztvQkFDNUIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsQ0FBQztvQkFDeEMsSUFBSSxNQUFNLEVBQUU7d0JBQ1YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7cUJBQ3JDO2lCQUNGO2FBQ0Y7U0FDRjtRQUVELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQ3hCLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDWixPQUFPO1lBQ1AsR0FBRztTQUNKLENBQUMsRUFDRixNQUFNLENBQ1AsQ0FBQztRQUVGLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTFCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcmVjb3JkcyBmcm9tIFwiLi9yZWNvcmRzLmpzXCI7XG5cbmltcG9ydCB7XG4gIEFkZE9uLFxuICBCdW5kbGUsXG4gIERhdGFTdG9yZSxcbiAgR2FtZSxcbiAgUHJpY2VzLFxuICBTa3UsXG4gIFN1YnNjcmlwdGlvbixcbn0gZnJvbSBcIi4vZGF0YS5qc1wiO1xuXG5pbXBvcnQgeyBQcm90b0RhdGEgfSBmcm9tIFwiLi9zdGFkaWEuanNcIjtcblxuZXhwb3J0IGNvbnN0IHNwaWRlciA9IGFzeW5jICgpID0+IHtcbiAgY29uc3Qgc3RvcmFnZSA9IGF3YWl0IERhdGFTdG9yZS5vcGVuKCk7XG4gIGNvbnN0IHNwaWRlciA9IG5ldyBTcGlkZXIoKTtcbiAgY29uc29sZS5kZWJ1ZyhcInN0YXJ0aW5nIHNwaWRlclwiLCBzcGlkZXIpO1xuICBjb25zdCBkYXRhID0gYXdhaXQgc3BpZGVyLmxvYWQoKTtcbiAgY29uc29sZS5kZWJ1ZyhcImNvbXBsZXRlZCBzcGlkZXJcIiwgc3BpZGVyLCBkYXRhKTtcbiAgYXdhaXQgc3RvcmFnZS5zYXZlKCk7XG4gIHNwaWRlci5kb3dubG9hZCgpO1xufTtcblxuY2xhc3MgU3BpZGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGFydDogKCkgPT4gdm9pZDtcbiAgcHJpdmF0ZSByZWFkb25seSBkb25lOiBQcm9taXNlPHVua25vd24+O1xuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBza3VzOiBSZWNvcmQ8U2t1W1wic2t1XCJdLCBTa3U+ID0ge30sXG4gICAgcHJpdmF0ZSByZWFkb25seSBzcGlkZXJlZDogUmVjb3JkPFNrdVtcInNrdVwiXSwgdHJ1ZT4gPSB7fSxcbiAgKSB7XG4gICAgbGV0IHN0YXJ0OiAoKSA9PiB2b2lkO1xuICAgIGNvbnN0IHN0YXJ0ZWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IChzdGFydCA9IHJlc29sdmUpKTtcbiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQ7XG4gICAgdGhpcy5kb25lID0gc3RhcnRlZFxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zcGlkZXIoKSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgT2JqZWN0LmZyZWV6ZSh0aGlzLnNrdXMpO1xuICAgICAgICBmb3IgKGNvbnN0IHNrdSBvZiBPYmplY3QudmFsdWVzKHRoaXMuc2t1cykpIHtcbiAgICAgICAgICBPYmplY3QuZnJlZXplKHNrdSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxvYWQoKSB7XG4gICAgdGhpcy5zdGFydCgpO1xuICAgIGF3YWl0IHRoaXMuZG9uZTtcbiAgICByZXR1cm4gdGhpcy5vdXRwdXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3BpZGVyKCkge1xuICAgIGlmIChmYWxzZSkge1xuICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhcIjU5YzgzMTRhYzgyYTQ1NmJhNjFkMDg5ODhiMTViNTUwXCIpO1xuICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhcImIxNzFmYzc4ZDRlMTQ5NmQ5NTM2ZDU4NTI1N2E3NzFlXCIpO1xuICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhcIjQ5NTA5NTkzODAwMzRkY2RhMGFlY2Y5OGY2NzVlMTFmXCIpO1xuICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhcIjJlMDdkYjVkMzM4ZDQwY2I5ZWFjOWRlYWU0MTU0ZjExXCIpO1xuICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1TGlzdCgzKTtcbiAgICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoMjAwMSk7XG4gICAgICBhd2FpdCB0aGlzLmxvYWRTa3VMaXN0KDQ1KTtcbiAgICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoNik7XG4gICAgICB0aHJvdyBcIlRPRE86IHJlbW92ZSBtZVwiO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMubG9hZFNrdUxpc3QoMyk7XG5cbiAgICB3aGlsZSAoT2JqZWN0LmtleXModGhpcy5za3VzKS5sZW5ndGggPiBPYmplY3Qua2V5cyh0aGlzLnNwaWRlcmVkKS5sZW5ndGgpIHtcbiAgICAgIGZvciAoY29uc3Qgc2t1IG9mIE9iamVjdC52YWx1ZXModGhpcy5za3VzKSkge1xuICAgICAgICBpZiAodGhpcy5zcGlkZXJlZFtza3Uuc2t1XSAhPT0gdHJ1ZSkge1xuICAgICAgICAgIGNvbnNvbGUuZGVidWcoXCJzcGlkZXJpbmcgXCIsIHNrdSk7XG4gICAgICAgICAgYXdhaXQgdGhpcy5sb2FkU2t1RGV0YWlscyhza3Uuc2t1KTtcbiAgICAgICAgICB0aGlzLnNwaWRlcmVkW3NrdS5za3VdID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvdXRwdXQoKSB7XG4gICAgcmV0dXJuIHJlY29yZHMuc29ydGVkKFxuICAgICAgT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgICBPYmplY3QudmFsdWVzKHRoaXMuc2t1cylcbiAgICAgICAgICAubWFwKHNrdSA9PiByZWNvcmRzLnNvcnRlZChza3UpKVxuICAgICAgICAgIC5tYXAoc2t1ID0+IFtza3UubG9jYWxLZXksIHNrdV0pLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGRvd25sb2FkKCkge1xuICAgIGNvbnN0IG91dHB1dCA9IHRoaXMub3V0cHV0KCk7XG4gICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KG91dHB1dCwgbnVsbCwgMik7XG4gICAgLy8gWFhYOiB0aGlzIGJsb2IgaXMgbGVha2VkXG4gICAgY29uc3QgaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoXG4gICAgICBuZXcgQmxvYihbanNvbl0sIHtcbiAgICAgICAgdHlwZTogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICB9KSxcbiAgICApO1xuICAgIGNvbnN0IGVsID0gT2JqZWN0LmFzc2lnbihkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYVwiKSwge1xuICAgICAgZG93bmxvYWQ6IFwic2t1cy5qc29uXCIsXG4gICAgICBocmVmLFxuICAgIH0pO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWwpO1xuICAgIGVsLmNsaWNrKCk7XG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlbCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRTa3VMaXN0KG51bWJlcjogbnVtYmVyKSB7XG4gICAgYXdhaXQgdGhpcy5mZXRjaFByZWxvYWREYXRhKGBzdG9yZS9saXN0LyR7bnVtYmVyfWApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkU2t1RGV0YWlscyhza3U6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuZmV0Y2hQcmVsb2FkRGF0YShgc3RvcmUvZGV0YWlscy9fL3NrdS8ke3NrdX1gKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFNrdURhdGEoZGF0YTogUHJvdG9EYXRhLCBwcmljZURhdGE6IFByb3RvRGF0YSk6IFNrdSB7XG4gICAgY29uc3QgYXBwOiBzdHJpbmcgPSBkYXRhWzRdO1xuICAgIGNvbnN0IHNrdUlkOiBzdHJpbmcgPSBkYXRhWzBdO1xuICAgIGNvbnN0IG5hbWU6IHN0cmluZyA9IGRhdGFbMV07XG4gICAgY29uc3QgaW50ZXJuYWxTbHVnOiBzdHJpbmcgPSBkYXRhWzVdO1xuICAgIGNvbnN0IGRlc2NyaXB0aW9uOiBzdHJpbmcgPSBkYXRhWzldO1xuXG4gICAgY29uc3QgcHJpY2VzID0gcHJpY2VEYXRhICYmIFByaWNlcy5mcm9tUHJvdG8ocHJpY2VEYXRhKTtcblxuICAgIGNvbnN0IHR5cGVJZCA9IGRhdGFbNl07XG5cbiAgICBjb25zb2xlLmxvZyh7IG5hbWUsIGRhdGEsIHByaWNlRGF0YSwgcHJpY2VzIH0pO1xuXG4gICAgbGV0IHNrdTtcbiAgICBpZiAodHlwZUlkID09PSAxKSB7XG4gICAgICBza3UgPSBuZXcgR2FtZShcbiAgICAgICAgYXBwLFxuICAgICAgICBza3VJZCxcbiAgICAgICAgXCJnYW1lXCIsXG4gICAgICAgIG5hbWUsXG4gICAgICAgIGludGVybmFsU2x1ZyxcbiAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgIHByaWNlcyxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDIpIHtcbiAgICAgIHNrdSA9IG5ldyBBZGRPbihcbiAgICAgICAgYXBwLFxuICAgICAgICBza3VJZCxcbiAgICAgICAgXCJhZGRvblwiLFxuICAgICAgICBuYW1lLFxuICAgICAgICBpbnRlcm5hbFNsdWcsXG4gICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICBwcmljZXMsXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAodHlwZUlkID09PSAzKSB7XG4gICAgICBza3UgPSBuZXcgQnVuZGxlKFxuICAgICAgICBhcHAsXG4gICAgICAgIHNrdUlkLFxuICAgICAgICBcImJ1bmRsZVwiLFxuICAgICAgICBuYW1lLFxuICAgICAgICBpbnRlcm5hbFNsdWcsXG4gICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICBwcmljZXMsXG4gICAgICAgIGRhdGFbMTRdWzBdLm1hcCgoeDogYW55KSA9PiB4WzBdKSxcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmICh0eXBlSWQgPT09IDUpIHtcbiAgICAgIHNrdSA9IG5ldyBTdWJzY3JpcHRpb24oXG4gICAgICAgIGFwcCxcbiAgICAgICAgc2t1SWQsXG4gICAgICAgIFwic3Vic2NyaXB0aW9uXCIsXG4gICAgICAgIG5hbWUsXG4gICAgICAgIGludGVybmFsU2x1ZyxcbiAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgIHByaWNlcyxcbiAgICAgICAgZGF0YVsxNF1bMF0ubWFwKCh4OiBhbnkpID0+IHhbMF0pLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgdW5leHBlY3RlZCBza3UgdHlwZSBpZCAke0pTT04uc3RyaW5naWZ5KHR5cGVJZCwgbnVsbCwgNCl9YCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubG9hZFNrdShza3UpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkU2t1KHNrdTogU2t1KTogU2t1IHtcbiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuc2t1c1tza3Uuc2t1XTtcbiAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nSnNvbiA9IEpTT04uc3RyaW5naWZ5KGV4aXN0aW5nKTtcbiAgICAgIGNvbnN0IG5ld0pzb24gPSBKU09OLnN0cmluZ2lmeShza3UpO1xuICAgICAgaWYgKGV4aXN0aW5nSnNvbiAhPT0gbmV3SnNvbikge1xuICAgICAgICBjb25zb2xlLndhcm4oYHNrdXMgaGFkIHNhbWUgaWRzIGJ1dCBkaWZmZXJlbnQgcHJvcGVydGllcy5gKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihleGlzdGluZywgc2t1KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBleGlzdGluZztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5za3VzW3NrdS5za3VdID0gc2t1O1xuICAgICAgcmV0dXJuIHNrdTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmZXRjaFByZWxvYWREYXRhKHBhdGg6IHN0cmluZykge1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT5cbiAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgTWF0aC5yYW5kb20oKSAqIDFfMDAwICsgMl8wMDApLFxuICAgICk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcImh0dHBzOi8vc3RhZGlhLmdvb2dsZS5jb20vXCIgKyBwYXRoLCB7XG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiVXNlci1BZ2VudFwiOlxuICAgICAgICAgIFwiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzgxLjAuNDA0NC4xMzggU2FmYXJpLzUzNy4zNlwiLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb25zdCBodG1sID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgIGNvbnN0IGRvY3VtZW50ID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhodG1sLCBcInRleHQvaHRtbFwiKTtcbiAgICBjb25zdCBzY3JpcHRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5zY3JpcHRzKTtcbiAgICBjb25zdCBjb250ZW50cyA9IHNjcmlwdHMubWFwKHMgPT4gcy50ZXh0Q29udGVudD8udHJpbSgpKS5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICBjb25zdCBkYXRhU2VydmljZVJlcXVlc3RzUGF0dGVybiA9IC9edmFyICpBRl9pbml0RGF0YUtleXNbXl0qP3ZhciAqQUZfZGF0YVNlcnZpY2VSZXF1ZXN0cyAqPSAqKHtbXl0qfSk7ICo/dmFyIC87XG5cbiAgICBjb25zdCBkYXRhU2VydmljZVJlcXVlc3RzID0gY29udGVudHNcbiAgICAgIC5tYXAocyA9PiBzLm1hdGNoKGRhdGFTZXJ2aWNlUmVxdWVzdHNQYXR0ZXJuKSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbilcbiAgICAgIC5tYXAobWF0Y2hlcyA9PlxuICAgICAgICBKU09OLnBhcnNlKFxuICAgICAgICAgIG1hdGNoZXNbMV1cbiAgICAgICAgICAgIC5yZXBsYWNlKC97aWQ6L2csICd7XCJpZFwiOicpXG4gICAgICAgICAgICAucmVwbGFjZSgvLHJlcXVlc3Q6L2csICcsXCJyZXF1ZXN0XCI6JylcbiAgICAgICAgICAgIC5yZXBsYWNlKC8nL2csICdcIicpLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgLm1hcChyZXF1ZXN0cyA9PlxuICAgICAgICBPYmplY3QuZnJvbUVudHJpZXMoXG4gICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVxdWVzdHMpLm1hcCgoW2tleSwgdmFsdWVdOiBhbnkpID0+IFtrZXksIHZhbHVlXSksXG4gICAgICAgICksXG4gICAgICApWzBdO1xuXG4gICAgY29uc3QgZGF0YUNhbGxiYWNrUGF0dGVybiA9IC9eICpBRl9pbml0RGF0YUNhbGxiYWNrICpcXCggKnsgKmtleSAqOiAqJ2RzOihbMC05XSs/KScgKixbXl0qP2RhdGE6ICpmdW5jdGlvbiAqXFwoICpcXCl7ICpyZXR1cm4gKihbXl0qKVxccyp9XFxzKn1cXHMqXFwpXFxzKjs/XFxzKiQvO1xuICAgIGNvbnN0IGRhdGFTZXJ2aWNlTG9hZHM6IEFycmF5PGFueT4gPSBbXTtcbiAgICBmb3IgKGNvbnN0IG1hdGNoZXMgb2YgY29udGVudHNcbiAgICAgIC5tYXAocyA9PiBzLm1hdGNoKGRhdGFDYWxsYmFja1BhdHRlcm4pKVxuICAgICAgLmZpbHRlcihCb29sZWFuKSkge1xuICAgICAgZGF0YVNlcnZpY2VMb2Fkc1ttYXRjaGVzWzFdXSA9IEpTT04ucGFyc2UobWF0Y2hlc1syXSk7XG4gICAgfVxuICAgIDY7XG4gICAgY29uc3QgZGF0YVNlcnZpY2VScGNQcmVmaXhlcyA9IE9iamVjdC52YWx1ZXMoZGF0YVNlcnZpY2VSZXF1ZXN0cykubWFwKFxuICAgICAgKHg6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBwaWVjZXMgPSBbeC5pZCwgLi4ueC5yZXF1ZXN0XTtcbiAgICAgICAgY29uc3QgYWxpYXNlcyA9IFtdO1xuICAgICAgICBhbGlhc2VzLnB1c2goXG4gICAgICAgICAgYCR7cGllY2VzWzBdfV8ke3BpZWNlcy5maWx0ZXIoKHg6IGFueSkgPT4geCAhPSBudWxsKS5sZW5ndGggLSAxfXMke1xuICAgICAgICAgICAgcGllY2VzLmZpbHRlcihCb29sZWFuKS5sZW5ndGggLSAxXG4gICAgICAgICAgfXQke3BpZWNlcy5sZW5ndGggLSAxfWFgLFxuICAgICAgICApO1xuICAgICAgICB3aGlsZSAocGllY2VzLmxlbmd0aCkge1xuICAgICAgICAgIGFsaWFzZXMucHVzaChwaWVjZXMuam9pbihcIl9cIikpO1xuICAgICAgICAgIHBpZWNlcy5wb3AoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWxpYXNlcztcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbnN0IHByZWxvYWQgPSBPYmplY3QudmFsdWVzKGRhdGFTZXJ2aWNlTG9hZHMpO1xuICAgIGNvbnN0IHJwYzogYW55ID0ge307XG4gICAgY29uc3QgbG9hZGVkID0ge307XG5cbiAgICBjb25zdCBsb2FkZXJzOiBhbnkgPSB7XG4gICAgICBXd0QzcmI6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3Qgc2t1cyA9IGRhdGFbMl0ubWFwKChwOiBhbnkpID0+IHRoaXMubG9hZFNrdURhdGEocFs5XSwgcFs5XVsxNV0pKTtcbiAgICAgICAgcmV0dXJuIHsgc2t1cyB9O1xuICAgICAgfSxcblxuICAgICAgRldoUVZfMjRyOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IGdhbWVEYXRhID0gZGF0YVsxOF0/LlswXT8uWzldO1xuICAgICAgICBjb25zdCBnYW1lUHJpY2luZ0RhdGEgPSBkYXRhWzE4XT8uWzBdPy5bMTVdPy5bMF07XG4gICAgICAgIGNvbnN0IGdhbWUgPSBnYW1lRGF0YSAmJiB0aGlzLmxvYWRTa3VEYXRhKGdhbWVEYXRhLCBnYW1lUHJpY2luZ0RhdGEpO1xuXG4gICAgICAgIGNvbnN0IGFkZG9ucyA9IChkYXRhWzE5XSBhcyBhbnkpPy5tYXAoKHg6IGFueSkgPT5cbiAgICAgICAgICB0aGlzLmxvYWRTa3VEYXRhKHhbOV0pLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHNrdURhdGEgPSBkYXRhWzE2XTtcbiAgICAgICAgY29uc3Qgc2t1UHJpY2luZ0RhdGEgPSBkYXRhWzIxXT8uWzBdO1xuICAgICAgICBjb25zdCBza3UgPSBza3VEYXRhICYmIHRoaXMubG9hZFNrdURhdGEoc2t1RGF0YSwgc2t1UHJpY2luZ0RhdGEpO1xuXG4gICAgICAgIHJldHVybiB7IHNrdSwgZ2FtZSwgYWRkb25zIH07XG4gICAgICB9LFxuXG4gICAgICBTWWNzVGQ6IChkYXRhOiBQcm90b0RhdGEpID0+IHtcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uRGF0YXMgPSBkYXRhWzJdPy5tYXAoKHg6IGFueSkgPT4geFs5XSkgPz8gW107XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBzdWJzY3JpcHRpb25EYXRhcy5tYXAocyA9PiB0aGlzLmxvYWRTa3VEYXRhKHMpKTtcbiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbnM/Lmxlbmd0aCkgcmV0dXJuIHsgc3Vic2NyaXB0aW9ucyB9O1xuICAgICAgICBlbHNlIHJldHVybiB7fTtcbiAgICAgIH0sXG5cbiAgICAgIFpBbTdXOiAoZGF0YTogUHJvdG9EYXRhKSA9PiB7XG4gICAgICAgIGNvbnN0IGJ1bmRsZXMgPSBkYXRhWzFdLm1hcCgoeDogYW55KSA9PiB0aGlzLmxvYWRTa3VEYXRhKHhbOV0pKTtcbiAgICAgICAgcmV0dXJuIHsgYnVuZGxlcyB9O1xuICAgICAgfSxcbiAgICB9O1xuXG4gICAgZm9yIChjb25zdCBbaSwgZGF0YV0gb2YgT2JqZWN0LmVudHJpZXMocHJlbG9hZCkpIHtcbiAgICAgIGZvciAoY29uc3QgcHJlZml4IG9mIGRhdGFTZXJ2aWNlUnBjUHJlZml4ZXNbaV0pIHtcbiAgICAgICAgZm9yIChjb25zdCBzdWZmaXggb2YgW1wiXCIsIFwiX1wiICsgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoICsgXCJyXCJdKSB7XG4gICAgICAgICAgcnBjW3ByZWZpeCArIHN1ZmZpeF0gPSBkYXRhO1xuICAgICAgICAgIGNvbnN0IGxvYWRlciA9IGxvYWRlcnNbcHJlZml4ICsgc3VmZml4XTtcbiAgICAgICAgICBpZiAobG9hZGVyKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGxvYWRlZCwgbG9hZGVyKGRhdGEpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIE9iamVjdC5jcmVhdGUoe1xuICAgICAgICBwcmVsb2FkLFxuICAgICAgICBycGMsXG4gICAgICB9KSxcbiAgICAgIGxvYWRlZCxcbiAgICApO1xuXG4gICAgY29uc29sZS5kZWJ1ZyhwYXRoLCBkYXRhKTtcblxuICAgIHJldHVybiBkYXRhO1xuICB9XG59XG4iXX0=
